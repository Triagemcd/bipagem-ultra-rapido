<p style="text-align: center; color: #64748b;">Nenhum lote conclu√≠do ainda</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Operator Modal -->
    <div id="addOperatorModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar Novo Operador</h3>
            </div>
            <div class="form-group">
                <label for="newMatricula">Matr√≠cula</label>
                <input type="text" id="newMatricula" class="form-control" placeholder="Ex: 1234">
            </div>
            <div class="form-group">
                <label for="newNome">Nome Completo</label>
                <input type="text" id="newNome" class="form-control" placeholder="Ex: Jo√£o Silva">
            </div>
            <div class="form-group">
                <label for="newSenha">Senha</label>
                <input type="password" id="newSenha" class="form-control" placeholder="Senha do operador">
            </div>
            <div class="modal-footer">
                <button onclick="addNewOperator()" class="btn btn-success">Adicionar</button>
                <button onclick="hideAddOperatorModal()" class="btn btn-danger">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - CONFIGURA√á√ïES REAIS!
        const firebaseConfig = {
            apiKey: "AIzaSyAE42of33RhUBWOxhf1UUzlxQJzForr6D0",
            authDomain: "bipagem-ultra-rapido.firebaseapp.com",
            databaseURL: "https://bipagem-ultra-rapido-default-rtdb.firebaseio.com",
            projectId: "bipagem-ultra-rapido",
            storageBucket: "bipagem-ultra-rapido.firebasestorage.app",
            messagingSenderId: "568114872656",
            appId: "1:568114872656:web:70131f762e6cd44df1ac55",
            measurementId: "G-S985R92CSS"
        };

        // Initialize Firebase
        let database;
        let isFirebaseConnected = false;

        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                // Test connection
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snapshot) => {
                    isFirebaseConnected = snapshot.val();
                    updateSyncStatus(isFirebaseConnected ? 'online' : 'offline');
                    console.log('üî• Firebase connection:', isFirebaseConnected ? 'Online' : 'Offline');
                });

                console.log('üî• Firebase inicializado com sucesso!');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Firebase:', error);
                console.log('üì± Usando modo offline com localStorage');
                updateSyncStatus('offline');
                return false;
            }
        }

        // Global Variables
        let currentUser = null;
        let currentCodes = {};
        let bipados = {};
        let stats = {
            total: 0,
            success: 0,
            error: 0,
            duplicate: 0,
            notFound: 0,
            times: []
        };
        let history = [];
        let selectedCeps = [];
        let completedBatches = [];
        let audioContext = null;
        let importedData = null;
        let validationChart = null;
        let firebaseListeners = [];

        // Default Data (fallback for offline mode)
        const defaultOperators = {
            "1234": {
                "nome": "Jo√£o Silva",
                "senha": "1234",
                "perfil": "operador"
            },
            "5678": {
                "nome": "Maria Santos",
                "senha": "5678",
                "perfil": "operador"
            },
            "9999": {
                "nome": "Carlos Supervisor",
                "senha": "9999",
                "perfil": "supervisor"
            }
        };

        const defaultCodes = {
            "lastUpdate": new Date().toISOString(),
            "totalCodes": 3,
            "codes": {
                "BR259664361786M": "35325000",
                "BR255742540216R": "35325000",
                "BR259460433507O": "35340000"
            }
        };

        // Sound Configuration with higher volume
        const soundConfig = {
            success: { frequency: 800, duration: 0.2, type: 'sine', volume: 0.3 },
            error: { frequency: 300, duration: 0.4, type: 'square', volume: 0.3 },
            duplicate: { frequency: 600, duration: 0.15, type: 'triangle', volume: 0.3 },
            notFound: { frequency: [400, 600], duration: 0.3, volume: 0.3 }
        };

        // Initialize Application
        function init() {
            console.log('üî• Inicializando Sistema de Bipagem Ultra-R√°pido v3.0 - Firebase Edition...');
            
            // Initialize Firebase first
            const firebaseReady = initFirebase();
            
            // Initialize default data if not exists (fallback)
            if (!localStorage.getItem('bipagem_operators')) {
                localStorage.setItem('bipagem_operators', JSON.stringify(defaultOperators));
            }
            
            // Load data based on Firebase availability
            if (firebaseReady) {
                loadCodesFromFirebase();
            } else {
                loadCodesFromLocal();
            }
            
            // Check existing session
            checkSession();
            
            // Setup event listeners
            setupEventListeners();

            console.log('‚úÖ Sistema inicializado com sucesso!');
        }

        // Firebase Functions
        async function loadCodesFromFirebase() {
            try {
                const snapshot = await database.ref('sistema/codes').once('value');
                const firebaseCodes = snapshot.val();
                
                if (firebaseCodes) {
                    currentCodes = firebaseCodes.codes || {};
                    console.log(`üî• Carregados ${Object.keys(currentCodes).length} c√≥digos do Firebase`);
                    
                    // Save to localStorage as backup
                    localStorage.setItem('bipagem_imported_codes', JSON.stringify(firebaseCodes));
                } else {
                    console.log('üì¶ Nenhum c√≥digo encontrado no Firebase, usando dados padr√£o');
                    currentCodes = defaultCodes.codes;
                    // Initialize Firebase with default data
                    await saveCodeToFirebase(defaultCodes);
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar c√≥digos do Firebase:', error);
                loadCodesFromLocal();
            }
        }

        function loadCodesFromLocal() {
            const stored = localStorage.getItem('bipagem_imported_codes');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    currentCodes = data.codes || {};
                    console.log(`üì± Carregados ${Object.keys(currentCodes).length} c√≥digos do localStorage`);
                } catch (e) {
                    console.error('Erro ao carregar c√≥digos locais:', e);
                    currentCodes = defaultCodes.codes;
                }
            } else {
                currentCodes = defaultCodes.codes;
            }
        }

        async function saveCodeToFirebase(codesData) {
            if (!isFirebaseConnected) {
                console.log('üì± Firebase offline, salvando localmente');
                localStorage.setItem('bipagem_imported_codes', JSON.stringify(codesData));
                return false;
            }

            try {
                await database.ref('sistema/codes').set(codesData);
                console.log('üî• C√≥digos salvos no Firebase com sucesso!');
                
                // Also save locally as backup
                localStorage.setItem('bipagem_imported_codes', JSON.stringify(codesData));
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao salvar no Firebase:', error);
                localStorage.setItem('bipagem_imported_codes', JSON.stringify(codesData));
                return false;
            }
        }

        async function saveValidationToFirebase(code, validationData) {
            if (!isFirebaseConnected) {
                console.log('üì± Firebase offline, salvando valida√ß√£o localmente');
                return;
            }

            try {
                // Clean code key for Firebase (remove special characters)
                const cleanCode = code.replace(/[.#$/[\]]/g, '_');
                
                await database.ref(`sistema/validacoes/${cleanCode}`).set(validationData);
                
                // Update operator stats in real-time
                const operatorRef = database.ref(`sistema/operadores/${currentUser.matricula}`);
                await operatorRef.update({
                    nome: currentUser.nome,
                    lastActivity: new Date().toISOString(),
                    online: true
                });
                
                console.log('üî• Valida√ß√£o salva no Firebase');
            } catch (error) {
                console.error('‚ùå Erro ao salvar valida√ß√£o no Firebase:', error);
            }
        }

        function setupFirebaseListeners() {
            if (!isFirebaseConnected || !currentUser) return;

            // Listen for code updates (for operators)
            if (currentUser.perfil === 'operador') {
                const codesRef = database.ref('sistema/codes');
                codesRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.codes) {
                        const newCodesCount = Object.keys(data.codes).length;
                        const oldCodesCount = Object.keys(currentCodes).length;
                        
                        if (newCodesCount > oldCodesCount) {
                            showNotification('üî• Novos c√≥digos sincronizados via Firebase!');
                        }
                        
                        currentCodes = data.codes;
                        localStorage.setItem('bipagem_imported_codes', JSON.stringify(data));
                        console.log('üî• C√≥digos atualizados em tempo real via Firebase');
                    }
                });
                firebaseListeners.push(codesRef);
            }

            // Listen for validations (for supervisor dashboard)
            if (currentUser.perfil === 'supervisor') {
                const validationsRef = database.ref('sistema/validacoes');
                validationsRef.on('value', (snapshot) => {
                    const validations = snapshot.val() || {};
                    
                    // Convert Firebase keys back to original codes
                    const convertedValidations = {};
                    Object.entries(validations).forEach(([cleanKey, data]) => {
                        // Try to find original code
                        const originalCode = Object.keys(currentCodes).find(code => 
                            code.replace(/[.#$/[\]]/g, '_') === cleanKey
                        );
                        if (originalCode) {
                            convertedValidations[originalCode] = data;
                        }
                    });
                    
                    bipados = convertedValidations;
                    console.log('üî• Valida√ß√µes atualizadas em tempo real');
                    updateDashboard();
                });
                firebaseListeners.push(validationsRef);

                // Listen for online operators
                const operatorsRef = database.ref('sistema/operadores');
                operatorsRef.on('value', (snapshot) => {
                    const operators = snapshot.val() || {};
                    updateActiveOperators(operators);
                });
                firebaseListeners.push(operatorsRef);
            }
        }

        function updateActiveOperators(operators) {
            const now = new Date();
            let activeCount = 0;
            
            Object.values(operators).forEach(op => {
                if (op.online && op.lastActivity) {
                    const lastActivity = new Date(op.lastActivity);
                    const diffMinutes = (now - lastActivity) / (1000 * 60);
                    if (diffMinutes < 5) { // Active in last 5 minutes
                        activeCount++;
                    }
                }
            });
            
            document.getElementById('activeOperators').textContent = activeCount;
        }

        function cleanupFirebaseListeners() {
            firebaseListeners.forEach(ref => {
                ref.off();
            });
            firebaseListeners = [];
        }

        function updateSyncStatus(status) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            if (!syncStatus || !syncText) return;
            
            syncStatus.className = `sync-status sync-${status}`;
            
            switch (status) {
                case 'online':
                    syncText.innerHTML = '<div class="realtime-dot"></div>üî• Firebase Online';
                    break;
                case 'offline':
                    syncText.textContent = 'üì± Modo Offline';
                    break;
                case 'syncing':
                    syncText.textContent = 'üîÑ Sincronizando...';
                    break;
            }
        }

        function checkSession() {
            const session = localStorage.getItem('bipagem_session');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    const sessionTime = new Date(sessionData.timestamp);
                    const now = new Date();
                    const diffHours = (now - sessionTime) / (1000 * 60 * 60);
                    
                    if (diffHours < 8) {
                        currentUser = sessionData.operator;
                        showMainApp();
                        return;
                    } else {
                        localStorage.removeItem('bipagem_session');
                    }
                } catch (e) {
                    localStorage.removeItem('bipagem_session');
                }
            }
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('matricula').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('senha').focus();
                }
            });

            document.getElementById('senha').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });

            // CEP input
            document.getElementById('cepInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCep();
                }
            });

            // Scanner input with improved clearing
            document.getElementById('scannerInput').addEventListener('input', function(e) {
                const value = e.target.value.trim();
                if (value.length >= 13) {
                    // Clear immediately to prevent concatenation
                    const code = value;
                    e.target.value = '';
                    
                    // Small delay to ensure proper clearing
                    setTimeout(() => {
                        validateCode(code);
                    }, 10);
                }
            });

            // File upload
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.getElementById('fileDropZone');

            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            // Search pendentes
            document.getElementById('searchPendentes').addEventListener('input', function(e) {
                searchPendentes(e.target.value);
            });

            // Auto-focus scanner with improved logic
            setInterval(() => {
                if (currentUser && currentUser.perfil === 'operador') {
                    const scannerInput = document.getElementById('scannerInput');
                    const activeElement = document.activeElement;
                    
                    // Only focus if not in a form input
                    if (scannerInput && 
                        activeElement.tagName !== 'INPUT' && 
                        activeElement.tagName !== 'TEXTAREA' &&
                        !activeElement.closest('.modal')) {
                        scannerInput.focus();
                    }
                }
            }, 2000);
        }

        // Authentication Functions
        function login() {
            const matricula = document.getElementById('matricula').value.trim();
            const senha = document.getElementById('senha').value.trim();

            if (!matricula || !senha) {
                showLoginError('Por favor, preencha todos os campos');
                return;
            }

            const operators = JSON.parse(localStorage.getItem('bipagem_operators') || '{}');
            
            if (operators[matricula] && operators[matricula].senha === senha) {
                currentUser = {
                    matricula: matricula,
                    nome: operators[matricula].nome,
                    perfil: operators[matricula].perfil
                };

                // Create session
                const sessionData = {
                    operator: currentUser,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('bipagem_session', JSON.stringify(sessionData));

                showMainApp();
                initializeAudio();
                setupFirebaseListeners();
                
                // Mark operator as online in Firebase
                if (isFirebaseConnected) {
                    database.ref(`sistema/operadores/${currentUser.matricula}`).update({
                        nome: currentUser.nome,
                        online: true,
                        lastActivity: new Date().toISOString()
                    });
                }
            } else {
                showLoginError('Matr√≠cula ou senha incorreta');
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 3000);
        }

        function logout() {
            // Mark operator as offline in Firebase
            if (isFirebaseConnected && currentUser) {
                database.ref(`sistema/operadores/${currentUser.matricula}`).update({
                    online: false,
                    lastActivity: new Date().toISOString()
                });
            }
            
            cleanupFirebaseListeners();
            localStorage.removeItem('bipagem_session');
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('matricula').value = '';
            document.getElementById('senha').value = '';
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('userInfo').textContent = `${currentUser.nome} (${currentUser.matricula})`;
            
            if (currentUser.perfil === 'operador') {
                document.getElementById('operatorInterface').classList.remove('hidden');
                document.getElementById('supervisorInterface').classList.add('hidden');
                document.getElementById('welcomeMessage').textContent = 'üì± Interface do Operador';
                loadOperatorData();
                document.getElementById('scannerInput').focus();
            } else {
                document.getElementById('operatorInterface').classList.add('hidden');
                document.getElementById('supervisorInterface').classList.remove('hidden');
                document.getElementById('welcomeMessage').textContent = 'üëë Dashboard do Supervisor';
                loadSupervisorData();
            }
        }

        // Audio Functions with improved volume
        function initializeAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn('Audio Context n√£o suportado:', e);
                }
            }
        }

        function playSound(type) {
            if (!audioContext) return;

            const config = soundConfig[type];
            if (!config) return;

            try {
                if (type === 'duplicate') {
                    // Two quick beeps
                    playTone(config.frequency, config.duration, config.volume);
                    setTimeout(() => playTone(config.frequency, config.duration, config.volume), 200);
                } else if (type === 'notFound') {
                    // Ascending tone
                    playTone(config.frequency[0], config.duration / 2, config.volume);
                    setTimeout(() => playTone(config.frequency[1], config.duration / 2, config.volume), config.duration * 400);
                } else {
                    playTone(config.frequency, config.duration, config.volume);
                }
            } catch (e) {
                console.warn('Erro ao reproduzir som:', e);
            }
        }

        function playTone(frequency, duration, volume = 0.1) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Tab Functions
        function switchTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            // Activate clicked tab
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // Special actions for specific tabs
            if (tabName === 'dashboard') {
                setTimeout(updateDashboard, 100);
            } else if (tabName === 'pendentes') {
                loadPendentes();
            } else if (tabName === 'lotes') {
                loadLotes();
            } else if (tabName === 'operadores') {
                loadOperators();
            } else if (tabName === 'historico') {
                loadHistory();
            }
        }

        // Operator Functions
        function loadOperatorData() {
            loadSelectedCeps();
            loadBipados();
            loadStats();
            updateStats();
            renderCepTags();
        }

        function loadSelectedCeps() {
            const stored = localStorage.getItem(`bipagem_selected_ceps_${currentUser.matricula}`);
            selectedCeps = stored ? JSON.parse(stored) : [];
        }

        function saveSelectedCeps() {
            localStorage.setItem(`bipagem_selected_ceps_${currentUser.matricula}`, JSON.stringify(selectedCeps));
        }

        function loadBipados() {
            // Try to load from Firebase first, then localStorage
            if (isFirebaseConnected) {
                // Firebase data is loaded via listener
                return;
            }
            
            const stored = localStorage.getItem('bipagem_bipados');
            bipados = stored ? JSON.parse(stored) : {};
        }

        function saveBipados() {
            localStorage.setItem('bipagem_bipados', JSON.stringify(bipados));
        }

        function loadStats() {
            const stored = localStorage.getItem(`bipagem_stats_${currentUser.matricula}`);
            if (stored) {
                stats = JSON.parse(stored);
            } else {
                stats = {
                    total: 0,
                    success: 0,
                    error: 0,
                    duplicate: 0,
                    notFound: 0,
                    times: []
                };
            }
        }

        function saveStats() {
            localStorage.setItem(`bipagem_stats_${currentUser.matricula}`, JSON.stringify(stats));
        }

        function addCep() {
            const input = document.getElementById('cepInput');
            let cep = input.value.trim().replace(/\D/g, '');
            
            if (cep.length !== 8) {
                alert('CEP deve ter exatamente 8 d√≠gitos');
                return;
            }

            if (selectedCeps.includes(cep)) {
                alert('CEP j√° adicionado');
                return;
            }

            selectedCeps.push(cep);
            saveSelectedCeps();
            renderCepTags();
            input.value = '';
            input.focus();
        }

        function removeCep(cep) {
            selectedCeps = selectedCeps.filter(c => c !== cep);
            saveSelectedCeps();
            renderCepTags();
            checkCompleteCepButton();
        }

        function renderCepTags() {
            const container = document.getElementById('cepTags');
            container.innerHTML = '';
            
            selectedCeps.forEach(cep => {
                const tag = document.createElement('div');
                tag.className = 'cep-tag';
                tag.innerHTML = `
                    ${cep.replace(/(\d{5})(\d{3})/, '$1-$2')}
                    <span class="remove" onclick="removeCep('${cep}')">√ó</span>
                `;
                container.appendChild(tag);
            });
        }

        async function validateCode(code) {
            if (selectedCeps.length === 0) {
                showResult('error', '‚ùå ERRO!', 'Configure pelo menos um CEP antes de bipar!', code);
                playSound('error');
                return;
            }

            const startTime = performance.now();
            
            // Check if code exists
            if (!currentCodes[code]) {
                showResult('not-found', 'üîç N√ÉO ENCONTRADO', 'C√≥digo n√£o existe na base de dados', code);
                playSound('notFound');
                updateStats('notFound', performance.now() - startTime);
                return;
            }

            const codeCep = currentCodes[code];
            
            // Check if already scanned
            if (bipados[code]) {
                const bipInfo = bipados[code];
                showResult('duplicate', 'üîÑ DUPLICADO!', `J√° validado √†s ${new Date(bipInfo.timestamp).toLocaleTimeString()} por ${bipInfo.operador}`, code);
                playSound('duplicate');
                updateStats('duplicate', performance.now() - startTime);
                return;
            }

            // Check if CEP matches
            if (selectedCeps.includes(codeCep)) {
                // Success!
                const validationData = {
                    timestamp: new Date().toISOString(),
                    operador: `${currentUser.nome} (${currentUser.matricula})`,
                    cep: codeCep,
                    resultado: 'success'
                };
                
                bipados[code] = validationData;
                saveBipados();
                
                // Save to Firebase in real-time
                await saveValidationToFirebase(code, validationData);
                
                showResult('success', '‚úÖ CORRETO!', `CEP: ${codeCep.replace(/(\d{5})(\d{3})/, '$1-$2')}`, code);
                playSound('success');
                updateStats('success', performance.now() - startTime);
                checkCompleteCepButton();
            } else {
                showResult('error', '‚ùå CEP ERRADO!', `Este c√≥digo √© do CEP: ${codeCep.replace(/(\d{5})(\d{3})/, '$1-$2')}`, code);
                playSound('error');
                updateStats('error', performance.now() - startTime);
            }
        }

        function showResult(type, title, message, code) {
            const resultDiv = document.getElementById('resultDisplay');
            
            // Remove all previous classes
            resultDiv.className = `result-display ${type} fade-in pulse`;
            
            // Get appropriate icon
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'duplicate': 'üîÑ',
                'not-found': 'üîç',
                'waiting': 'üî•'
            };
            
            resultDiv.innerHTML = `
                <div class="result-icon">${icons[type]}</div>
                <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">${title}</div>
                <div style="font-size: 16px; margin-bottom: 10px;">${message}</div>
                <div class="result-code" style="font-family: monospace; font-size: 14px; opacity: 0.8;">${code}</div>
            `;
            
            // Auto-clear after 4 seconds
            setTimeout(() => {
                resultDiv.className = 'result-display waiting';
                resultDiv.innerHTML = `
                    <div class="result-icon">üî•</div>
                    <div>Sistema Firebase Pronto!</div>
                    <div style="font-size: 12px; margin-top: 5px;">Aguardando c√≥digo...</div>
                `;
            }, 4000);
        }

        function updateStats(type, time) {
            stats.total++;
            stats[type]++;
            stats.times.push(time);
            
            // Keep only last 100 times for average calculation
            if (stats.times.length > 100) {
                stats.times = stats.times.slice(-100);
            }

            // Add to history
            history.unshift({
                timestamp: new Date().toISOString(),
                type: type,
                time: Math.round(time)
            });

            // Keep only last 20 in history
            if (history.length > 20) {
                history = history.slice(0, 20);
            }

            saveStats();
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            document.getElementById('totalBipagens').textContent = stats.total;
            document.getElementById('sucessos').textContent = stats.success;
            
            const taxaAcerto = stats.total > 0 ? Math.round((stats.success / stats.total) * 100) : 0;
            document.getElementById('taxaAcerto').textContent = `${taxaAcerto}%`;
            
            const tempoMedio = stats.times.length > 0 ? 
                Math.round(stats.times.reduce((a, b) => a + b, 0) / stats.times.length) : 0;
            document.getElementById('tempoMedio').textContent = `${tempoMedio}ms`;
        }

        function checkCompleteCepButton() {
            const hasSuccess = Object.values(bipados).some(b => 
                selectedCeps.includes(b.cep) && 
                b.operador.includes(currentUser.matricula) &&
                b.resultado === 'success'
            );
            
            const btn = document.getElementById('completeCepBtn');
            if (hasSuccess) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        function completeCep() {
            if (selectedCeps.length === 0) {
                alert('Nenhum CEP selecionado para concluir');
                return;
            }

            // Get codes for current CEPs and operator
            const codesForBatch = Object.entries(bipados)
                .filter(([code, info]) => 
                    selectedCeps.includes(info.cep) && 
                    info.operador.includes(currentUser.matricula) &&
                    info.resultado === 'success'
                )
                .map(([code, info]) => code);

            if (codesForBatch.length === 0) {
                alert('Nenhum c√≥digo v√°lido encontrado para os CEPs selecionados');
                return;
            }

            // Create batch
            selectedCeps.forEach(cep => {
                const codesForThisCep = codesForBatch.filter(code => bipados[code].cep === cep);
                if (codesForThisCep.length > 0) {
                    const batch = {
                        cep: cep,
                        operator: currentUser.nome,
                        matricula: currentUser.matricula,
                        timestamp: new Date().toISOString(),
                        codes: codesForThisCep
                    };
                    completedBatches.push(batch);
                }
            });

            // Save completed batches to Firebase and localStorage
            const existingBatches = JSON.parse(localStorage.getItem('bipagem_completed_ceps') || '[]');
            existingBatches.push(...completedBatches.slice(-selectedCeps.length));
            localStorage.setItem('bipagem_completed_ceps', JSON.stringify(existingBatches));

            // Save to Firebase
            if (isFirebaseConnected) {
                completedBatches.slice(-selectedCeps.length).forEach(batch => {
                    const batchKey = `${batch.cep}_${Date.now()}`;
                    database.ref(`sistema/lotes/${batchKey}`).set(batch);
                });
            }

            // Reset for new CEP
            selectedCeps = [];
            saveSelectedCeps();
            renderCepTags();
            document.getElementById('completeCepBtn').classList.add('hidden');

            showNotification(`‚úÖ CEP(s) conclu√≠do(s)! ${codesForBatch.length} c√≥digos processados.`);
        }

        function loadHistory() {
            const historyContainer = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p style="text-align: center; color: #64748b;">Nenhuma valida√ß√£o realizada ainda</p>';
                return;
            }

            let html = '';
            history.forEach(item => {
                const time = new Date(item.timestamp).toLocaleTimeString();
                const typeEmoji = {
                    'success': '‚úÖ',
                    'error': '‚ùå',
                    'duplicate': 'üîÑ',
                    'notFound': 'üîç'
                };
                
                html += `
                    <div class="history-item">
                        <span>${typeEmoji[item.type]} ${item.type.toUpperCase()}</span>
                        <span class="history-time">${time} (${item.time}ms)</span>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = html;
        }

        // Supervisor Functions
        function loadSupervisorData() {
            updateDashboard();
            loadOperators();
        }

        function updateDashboard() {
            // Update general stats
            const totalCodes = Object.keys(currentCodes).length;
            document.getElementById('totalCodes').textContent = totalCodes;

            // Count validated today
            const today = new Date().toDateString();
            const validatedToday = Object.values(bipados).filter(b => 
                new Date(b.timestamp).toDateString() === today
            ).length;
            document.getElementById('validatedToday').textContent = validatedToday;

            // Pending codes
            const pendingCodes = totalCodes - Object.keys(bipados).length;
            document.getElementById('pendingCodes').textContent = pendingCodes;

            // Update chart with delay to prevent loop
            setTimeout(updateValidationChart, 200);
        }

        function updateValidationChart() {
            const ctx = document.getElementById('validationChart');
            if (!ctx) return;
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js n√£o carregado, usando fallback');
                ctx.parentElement.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: var(--primary);">üìà Valida√ß√µes por Tipo</h3>
                    <div style="padding: 20px; text-align: center; color: #64748b;">
                        <p>Gr√°fico indispon√≠vel</p>
                        <p style="font-size: 12px;">Chart.js n√£o carregou</p>
                    </div>
                `;
                return;
            }
            
            // Destroy existing chart to prevent loop
            if (validationChart) {
                validationChart.destroy();
                validationChart = null;
            }

            const chartCtx = ctx.getContext('2d');
            
            // Count validation types from all operators
            let totalSuccess = 0, totalError = 0, totalDuplicate = 0, totalNotFound = 0;
            
            // Count from bipados (actual validations)
            Object.values(bipados).forEach(b => {
                if (b.resultado === 'success') totalSuccess++;
            });

            // Count from individual operator stats
            const operators = JSON.parse(localStorage.getItem('bipagem_operators') || '{}');
            Object.keys(operators).forEach(matricula => {
                const operatorStats = localStorage.getItem(`bipagem_stats_${matricula}`);
                if (operatorStats) {
                    const stats = JSON.parse(operatorStats);
                    totalError += stats.error || 0;
                    totalDuplicate += stats.duplicate || 0;
                    totalNotFound += stats.notFound || 0;
                }
            });

            try {
                validationChart = new Chart(chartCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Sucessos', 'CEP Errado', 'Duplicados', 'N√£o Encontrados'],
                        datasets: [{
                            data: [totalSuccess, totalError, totalDuplicate, totalNotFound],
                            backgroundColor: [
                                '#16a34a',
                                '#dc2626',
                                '#ea580c',
                                '#7c3aed'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        },
                        animation: {
                            duration: 1000
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao criar gr√°fico:', error);
                ctx.parentElement.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: var(--primary);">üìà Valida√ß√µes por Tipo</h3>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: #16a34a; color: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold;">${totalSuccess}</div>
                                <div>Sucessos</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #dc2626; color: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold;">${totalError}</div>
                                <div>Erros</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #ea580c; color: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold;">${totalDuplicate}</div>
                                <div>Duplicados</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #7c3aed; color: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold;">${totalNotFound}</div>
                                <div>N√£o Encontrados</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function loadOperators() {
            const operators = JSON.parse(localStorage.getItem('bipagem_operators') || '{}');
            const container = document.getElementById('operatorList');
            
            let html = '';
            Object.entries(operators).forEach(([matricula, data]) => {
                if (data.perfil === 'operador') {
                    html += `
                        <div class="operator-item">
                            <div class="operator-info">
                                <h4>${data.nome}</h4>
                                <p>Matr√≠cula: ${matricula} | Senha: ${'*'.repeat(data.senha.length)}</p>
                            </div>
                            <button onclick="removeOperator('${matricula}')" class="btn btn-danger">Remover</button>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                html = '<p style="text-align: center; color: #64748b; padding: 20px;">Nenhum operador cadastrado</p>';
            }
            
            container.innerHTML = html;
        }

        function showAddOperatorModal() {
            document.getElementById('addOperatorModal').classList.remove('hidden');
            document.getElementById('newMatricula').focus();
        }

        function hideAddOperatorModal() {
            document.getElementById('addOperatorModal').classList.add('hidden');
            document.getElementById('newMatricula').value = '';
            document.getElementById('newNome').value = '';
            document.getElementById('newSenha').value = '';
        }

        function addNewOperator() {
            const matricula = document.getElementById('newMatricula').value.trim();
            const nome = document.getElementById('newNome').value.trim();
            const senha = document.getElementById('newSenha').value.trim();

            if (!matricula || !nome || !senha) {
                alert('Por favor, preencha todos os campos');
                return;
            }

            const operators = JSON.parse(localStorage.getItem('bipagem_operators') || '{}');
            
            if (operators[matricula]) {
                alert('Matr√≠cula j√° existe');
                return;
            }

            operators[matricula] = {
                nome: nome,
                senha: senha,
                perfil: 'operador'
            };

            localStorage.setItem('bipagem_operators', JSON.stringify(operators));
            loadOperators();
            hideAddOperatorModal();
            showNotification('Operador adicionado com sucesso!');
        }

        function removeOperator(matricula) {
            if (confirm('Tem certeza que deseja remover este operador?')) {
                const operators = JSON.parse(localStorage.getItem('bipagem_operators') || '{}');
                delete operators[matricula];
                localStorage.setItem('bipagem_operators', JSON.stringify(operators));
                
                // Remove operator data
                localStorage.removeItem(`bipagem_stats_${matricula}`);
                localStorage.removeItem(`bipagem_selected_ceps_${matricula}`);
                
                loadOperators();
                showNotification('Operador removido com sucesso!');
            }
        }

        // Import/Export Functions
        function handleFileUpload(file) {
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                handleExcelFile(file);
            } else if (fileName.endsWith('.csv')) {
                handleCSVFile(file);
            } else {
                alert('Formato n√£o suportado. Use apenas XLSX, XLS ou CSV.');
            }
        }

        function handleExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Convert to array (no header)
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                        header: 1,
                        raw: false
                    });
                    
                    processImportData(jsonData);
                } catch (error) {
                    alert('Erro ao processar arquivo Excel: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function handleCSVFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const data = lines.map(line => line.split(',').map(cell => cell.trim()));
                    
                    processImportData(data);
                } catch (error) {
                    alert('Erro ao processar arquivo CSV: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        function processImportData(data) {
            const codes = {};
            let validCount = 0;
            let invalidCount = 0;
            
            data.forEach((row, index) => {
                if (row[0] && row[1]) {
                    const codigo = row[0].toString().trim();
                    const cep = row[1].toString().replace(/\D/g, '');
                    
                    if (codigo.length >= 13 && cep.length === 8) {
                        codes[codigo] = cep;
                        validCount++;
                    } else {
                        invalidCount++;
                    }
                } else if (row[0] || row[1]) {
                    invalidCount++;
                }
            });
            
            importedData = codes;
            showImportPreview(validCount, invalidCount);
        }

        function showImportPreview(validCount, invalidCount) {
            const preview = document.getElementById('importPreview');
            const content = document.getElementById('previewContent');
            
            content.innerHTML = `
                <div style="display: flex; gap: 20px; justify-content: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; color: var(--success); font-weight: bold;">${validCount}</div>
                        <div>C√≥digos V√°lidos</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; color: var(--error); font-weight: bold;">${invalidCount}</div>
                        <div>Linhas Ignoradas</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;">
                    <strong>üî• Firebase:</strong> Esta importa√ß√£o ser√° sincronizada instantaneamente com todos os operadores!
                </div>
            `;
            
            preview.classList.remove('hidden');
        }

        async function confirmImport() {
            if (!importedData) {
                alert('Nenhum dado para importar');
                return;
            }

            updateSyncStatus('syncing');

            const newCodesData = {
                lastUpdate: new Date().toISOString(),
                totalCodes: Object.keys(importedData).length,
                codes: importedData
            };

            // Save locally first
            localStorage.setItem('bipagem_imported_codes', JSON.stringify(newCodesData));
            currentCodes = importedData;
            
            // Clear existing validations
            localStorage.removeItem('bipagem_bipados');
            bipados = {};

            // Save to Firebase
            const firebaseSuccess = await saveCodeToFirebase(newCodesData);
            
            if (firebaseSuccess) {
                showNotification(`üî• ${Object.keys(importedData).length} c√≥digos importados e sincronizados via Firebase!`);
                updateSyncStatus('online');
            } else {
                showNotification(`üì± ${Object.keys(importedData).length} c√≥digos importados localmente. Firebase offline.`, 'warning');
                updateSyncStatus('offline');
            }

            cancelImport();
            updateDashboard();
        }

        function cancelImport() {
            document.getElementById('importPreview').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            importedData = null;
        }

        function loadPendentes() {
            const container = document.getElementById('pendentesList');
            const pendingCodes = Object.entries(currentCodes).filter(([code, cep]) => !bipados[code]);
            
            if (pendingCodes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b;">Todos os c√≥digos foram validados! üéâ</p>';
                return;
            }

            let html = `
                <div style="margin-bottom: 15px; font-weight: bold; color: var(--primary);">
                    ${pendingCodes.length} c√≥digos pendentes
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            pendingCodes.slice(0, 100).forEach(([code, cep]) => {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="font-family: monospace;">${code}</span>
                        <span>${cep.replace(/(\d{5})(\d{3})/, '$1-$2')}</span>
                    </div>
                `;
            });

            html += '</div>';
            
            if (pendingCodes.length > 100) {
                html += `<div style="text-align: center; margin-top: 15px; color: #64748b;">
                    Mostrando primeiros 100 de ${pendingCodes.length} c√≥digos
                </div>`;
            }

            container.innerHTML = html;
        }

        function searchPendentes(query) {
            if (!query.trim()) {
                loadPendentes();
                return;
            }

            const container = document.getElementById('pendentesList');
            const pendingCodes = Object.entries(currentCodes)
                .filter(([code, cep]) => !bipados[code])
                .filter(([code, cep]) => 
                    code.toLowerCase().includes(query.toLowerCase()) ||
                    cep.includes(query.replace(/\D/g, ''))
                );

            if (pendingCodes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b;">Nenhum c√≥digo encontrado para esta busca</p>';
                return;
            }

            let html = `
                <div style="margin-bottom: 15px; font-weight: bold; color: var(--primary);">
                    ${pendingCodes.length} c√≥digos encontrados
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            pendingCodes.slice(0, 50).forEach(([code, cep]) => {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                        <span style="font-family: monospace;">${code}</span>
                        <span>${cep.replace(/(\d{5})(\d{3})/, '$1-$2')}</span>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function exportPendentes() {
            const pendingCodes = Object.entries(currentCodes).filter(([code, cep]) => !bipados[code]);
            
            if (pendingCodes.length === 0) {
                alert('N√£o h√° c√≥digos pendentes para exportar');
                return;
            }

            const data = {
                exported_at: new Date().toISOString(),
                total_pending: pendingCodes.length,
                codes: Object.fromEntries(pendingCodes)
            };

            downloadJSON(data, `codigos_pendentes_${new Date().toISOString().split('T')[0]}.json`);
        }

        function loadLotes() {
            const container = document.getElementById('lotesList');
            const batches = JSON.parse(localStorage.getItem('bipagem_completed_ceps') || '[]');
            
            if (batches.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b;">Nenhum lote conclu√≠do ainda</p>';
                return;
            }

            // Group by CEP
            const groupedBatches = {};
            batches.forEach(batch => {
                const cep = batch.cep;
                if (!groupedBatches[cep]) {
                    groupedBatches[cep] = [];
                }
                groupedBatches[cep].push(batch);
            });

            let html = '';
            Object.entries(groupedBatches).forEach(([cep, batchList]) => {
                const totalCodes = batchList.reduce((sum, batch) => sum + batch.codes.length, 0);
                const operators = [...new Set(batchList.map(b => b.operator))].join(', ');
                const lastUpdate = new Date(Math.max(...batchList.map(b => new Date(b.timestamp)))).toLocaleString();

                html += `
                    <div style="background: var(--light); padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: var(--primary);">CEP: ${cep.replace(/(\d{5})(\d{3})/, '$1-$2')}</h4>
                            <button onclick="exportBatch('${cep}')" class="btn btn-warning">Exportar</button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px;">
                            <div><strong>C√≥digos:</strong> ${totalCodes}</div>
                            <div><strong>Operadores:</strong> ${operators}</div>
                            <div><strong>√öltima atualiza√ß√£o:</strong> ${lastUpdate}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function exportBatch(cep) {
            const batches = JSON.parse(localStorage.getItem('bipagem_completed_ceps') || '[]');
            const cepBatches = batches.filter(batch => batch.cep === cep);
            
            if (cepBatches.length === 0) {
                alert('Nenhum lote encontrado para este CEP');
                return;
            }

            const exportData = {
                cep: cep,
                exported_at: new Date().toISOString(),
                total_codes: cepBatches.reduce((sum, batch) => sum + batch.codes.length, 0),
                batches: cepBatches
            };

            downloadJSON(exportData, `lote_cep_${cep}_${new Date().toISOString().split('T')[0]}.json`);
        }

        function exportAllBatches() {
            const batches = JSON.parse(localStorage.getItem('bipagem_completed_ceps') || '[]');
            
            if (batches.length === 0) {
                alert('Nenhum lote para exportar');
                return;
            }

            const exportData = {
                exported_at: new Date().toISOString(),
                total_batches: batches.length,
                total_codes: batches.reduce((sum, batch) => sum + batch.codes.length, 0),
                batches: batches
            };

            downloadJSON(exportData, `todos_lotes_${new Date().toISOString().split('T')[0]}.json`);
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Utility Functions
        function updateStats() {
            updateStatsDisplay();
            checkCompleteCepButton();
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            if (type === 'warning') {
                notification.style.background = 'var(--warning)';
            } else if (type === 'error') {
                notification.style.background = 'var(--error)';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', function(e) {
            // ESC to clear scanner input
            if (e.key === 'Escape' && currentUser && currentUser.perfil === 'operador') {
                const scannerInput = document.getElementById('scannerInput');
                scannerInput.value = '';
                scannerInput.focus();
            }
        });

        // Auto-update dashboard every 5 seconds for supervisor
        setInterval(() => {
            if (currentUser && currentUser.perfil === 'supervisor') {
                const activeTab = document.querySelector('.tab-btn.active')?.textContent;
                if (activeTab === 'Dashboard') {
                    updateDashboard();
                }
            }
        }, 5000);

        // Format CEP display
        function formatCep(cep) {
            return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
        }

        // Validate CEP format
        function isValidCep(cep) {
            const cleanCep = cep.replace(/\D/g, '');
            return cleanCep.length === 8;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);

        // Console welcome message
        console.log(`
üî• Sistema de Bipagem Ultra-R√°pido v3.0 - Firebase Edition
üìä Performance Target: < 50ms (Firebase)
üíæ Armazenamento: Firebase Realtime Database + LocalStorage
üåê Hospedagem: GitHub Pages
‚ö° Status: Pronto para uso!

Recursos Firebase:
üî• Sincroniza√ß√£o instant√¢nea
üî• Dashboard em tempo real
üî• Operadores online/offline
üî• Valida√ß√µes ao vivo
üî• Backup autom√°tico
üî• Escalabilidade ilimitada

üîß Para configurar:
1. Crie projeto no Firebase Console
2. Ative Realtime Database  
3. Configure regras de seguran√ßa
4. Substitua firebaseConfig no c√≥digo

Desenvolvido para m√°xima performance e colabora√ß√£o em tempo real.
        `);

    </script>
</body>
</html><!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Bipagem Ultra-R√°pido</title>
    
    <!-- SheetJS para importa√ß√£o Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Chart.js para dashboard -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --error: #dc2626;
            --warning: #ea580c;
            --duplicate: #7c3aed;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary), #1e40af);
            min-height: 100vh;
            color: var(--dark);
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: var(--white);
            padding: 40px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 24px;
            margin-bottom: 8px;
        }

        .logo p {
            color: #64748b;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            min-width: 120px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--error);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-full {
            width: 100%;
        }

        /* Main Interface */
        .hidden {
            display: none !important;
        }

        .header {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h2 {
            color: var(--primary);
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            color: var(--dark);
            font-weight: 600;
        }

        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .sync-online {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success);
        }

        .sync-offline {
            background: rgba(220, 38, 38, 0.1);
            color: var(--error);
        }

        .sync-syncing {
            background: rgba(234, 88, 12, 0.1);
            color: var(--warning);
        }

        /* Tabs */
        .tabs {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab-nav {
            display: flex;
            background: var(--light);
            border-bottom: 1px solid #e2e8f0;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .tab-btn.active {
            background: var(--white);
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .tab-content {
            padding: 30px;
        }

        /* Operator Interface */
        .cep-config {
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .cep-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .cep-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .cep-tag {
            background: var(--primary);
            color: var(--white);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cep-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }

        .scanner-container {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .scanner-input {
            width: 100%;
            padding: 20px;
            border: 3px solid var(--primary);
            border-radius: 12px;
            font-size: 24px;
            font-family: 'Courier New', monospace;
            text-align: center;
            background: var(--light);
        }

        .result-display {
            min-height: 150px;
            margin-top: 20px;
            padding: 30px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            border: 3px solid #cbd5e1;
        }

        .result-display.waiting {
            background: var(--light);
            color: #64748b;
            border: 2px dashed #cbd5e1;
        }

        .result-display.success {
            background: var(--success);
            color: var(--white);
            border: 3px solid var(--success);
            box-shadow: 0 0 20px rgba(22, 163, 74, 0.3);
        }

        .result-display.error {
            background: var(--error);
            color: var(--white);
            border: 3px solid var(--error);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .result-display.duplicate {
            background: var(--warning);
            color: var(--white);
            border: 3px solid var(--warning);
            box-shadow: 0 0 20px rgba(234, 88, 12, 0.3);
        }

        .result-display.not-found {
            background: var(--duplicate);
            color: var(--white);
            border: 3px solid var(--duplicate);
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
        }

        .result-code {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin-top: 10px;
            opacity: 0.9;
        }

        .result-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: #64748b;
            margin-top: 5px;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .chart-container canvas {
            max-height: 400px !important;
        }

        /* Operator Management */
        .operator-list {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .operator-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .operator-item:last-child {
            border-bottom: none;
        }

        .operator-info {
            flex: 1;
        }

        .operator-info h4 {
            color: var(--dark);
            margin-bottom: 4px;
        }

        .operator-info p {
            color: #64748b;
            font-size: 14px;
        }

        /* Import/Export */
        .file-drop-zone {
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: rgba(37, 99, 235, 0.05);
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-drop-zone:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .file-drop-zone.dragover {
            background: rgba(37, 99, 235, 0.15);
            border-color: #1d4ed8;
        }

        .import-preview {
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .tab-nav {
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .cep-input-group {
                flex-direction: column;
            }

            .scanner-input {
                font-size: 18px;
                padding: 15px;
            }

            .result-display {
                min-height: 120px;
                padding: 20px;
                font-size: 16px;
            }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* History List */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            background: var(--light);
            border-radius: 8px;
            padding: 15px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            color: #64748b;
            font-size: 12px;
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: var(--white);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Realtime indicator */
        .realtime-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--success);
        }

        .realtime-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="logo">
                <h1>üî• Bipagem Ultra-R√°pido</h1>
                <p>Sistema de Valida√ß√£o Instant√¢nea - Firebase</p>
            </div>
            <div class="form-group">
                <label for="matricula">Matr√≠cula</label>
                <input type="text" id="matricula" class="form-control" placeholder="Digite sua matr√≠cula" autocomplete="username">
            </div>
            <div class="form-group">
                <label for="senha">Senha</label>
                <input type="password" id="senha" class="form-control" placeholder="Digite sua senha" autocomplete="current-password">
            </div>
            <button onclick="login()" class="btn btn-primary btn-full">Entrar</button>
            <div id="loginError" class="hidden" style="color: var(--error); text-align: center; margin-top: 15px; font-size: 14px;"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container hidden">
        <!-- Header -->
        <div class="header">
            <h2 id="welcomeMessage">Sistema de Bipagem</h2>
            <div class="user-info">
                <div id="syncStatus" class="sync-status sync-online">
                    <div class="realtime-dot"></div>
                    <span id="syncText">üî• Firebase Online</span>
                </div>
                <span id="userInfo"></span>
                <button onclick="logout()" class="btn btn-danger">Sair</button>
            </div>
        </div>

        <!-- Operator Interface -->
        <div id="operatorInterface" class="hidden">
            <div class="tabs">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab('bipagem')">Bipagem</button>
                    <button class="tab-btn" onclick="switchTab('historico')">Hist√≥rico</button>
                </div>
                
                <!-- Bipagem Tab -->
                <div id="tab-bipagem" class="tab-content">
                    <!-- CEP Configuration -->
                    <div class="cep-config">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üì¶ Configurar CEPs da Gaiola</h3>
                        <div class="cep-input-group">
                            <input type="text" id="cepInput" class="form-control" placeholder="Digite o CEP (ex: 36960000)" maxlength="9" style="flex: 1; min-width: 200px;">
                            <button onclick="addCep()" class="btn btn-primary">Adicionar CEP</button>
                        </div>
                        <div id="cepTags" class="cep-tags"></div>
                    </div>

                    <!-- Scanner -->
                    <div class="scanner-container">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üì± Scanner de C√≥digos</h3>
                        <input type="text" id="scannerInput" class="scanner-input" placeholder="Posicione o cursor aqui e bipe o c√≥digo" autocomplete="off">
                        <div id="resultDisplay" class="result-display waiting">
                            <div class="result-icon">üî•</div>
                            <div>Sistema Firebase Pronto!</div>
                            <div style="font-size: 12px; margin-top: 5px;">Aguardando c√≥digo...</div>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button id="completeCepBtn" onclick="completeCep()" class="btn btn-success hidden">
                                ‚úÖ Concluir CEP Atual
                            </button>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div id="totalBipagens" class="stat-value">0</div>
                            <div class="stat-label">Total Bipagens</div>
                        </div>
                        <div class="stat-card">
                            <div id="sucessos" class="stat-value">0</div>
                            <div class="stat-label">Sucessos</div>
                        </div>
                        <div class="stat-card">
                            <div id="taxaAcerto" class="stat-value">0%</div>
                            <div class="stat-label">Taxa de Acerto</div>
                        </div>
                        <div class="stat-card">
                            <div id="tempoMedio" class="stat-value">0ms</div>
                            <div class="stat-label">Tempo M√©dio</div>
                        </div>
                    </div>
                </div>

                <!-- Hist√≥rico Tab -->
                <div id="tab-historico" class="tab-content hidden">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">üìä Hist√≥rico de Valida√ß√µes</h3>
                    <div id="historyList" class="history-list">
                        <p style="text-align: center; color: #64748b;">Nenhuma valida√ß√£o realizada ainda</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Supervisor Interface -->
        <div id="supervisorInterface" class="hidden">
            <div class="tabs">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
                    <button class="tab-btn" onclick="switchTab('operadores')">Operadores</button>
                    <button class="tab-btn" onclick="switchTab('importar')">Importar</button>
                    <button class="tab-btn" onclick="switchTab('pendentes')">Pendentes</button>
                    <button class="tab-btn" onclick="switchTab('lotes')">Lotes</button>
                </div>

                <!-- Dashboard Tab -->
                <div id="tab-dashboard" class="tab-content">
                    <div style="margin-bottom: 20px; text-align: center;">
                        <div class="realtime-indicator">
                            <div class="realtime-dot"></div>
                            <span>Dashboard em tempo real via Firebase</span>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="chart-container">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">üìà Valida√ß√µes por Tipo</h3>
                            <div style="position: relative; height: 300px;">
                                <canvas id="validationChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">üìä Estat√≠sticas Gerais</h3>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div id="totalCodes" class="stat-value">0</div>
                                    <div class="stat-label">C√≥digos Totais</div>
                                </div>
                                <div class="stat-card">
                                    <div id="validatedToday" class="stat-value">0</div>
                                    <div class="stat-label">Validados Hoje</div>
                                </div>
                                <div class="stat-card">
                                    <div id="pendingCodes" class="stat-value">0</div>
                                    <div class="stat-label">Pendentes</div>
                                </div>
                                <div class="stat-card">
                                    <div id="activeOperators" class="stat-value">0</div>
                                    <div class="stat-label">Operadores Online</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Operadores Tab -->
                <div id="tab-operadores" class="tab-content hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">üë• Gerenciar Operadores</h3>
                        <button onclick="showAddOperatorModal()" class="btn btn-primary">Adicionar Operador</button>
                    </div>
                    <div id="operatorList" class="operator-list"></div>
                </div>

                <!-- Importar Tab -->
                <div id="tab-importar" class="tab-content hidden">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">üì• Importar C√≥digos via Firebase</h3>
                    <div id="fileDropZone" class="file-drop-zone">
                        <div style="margin-bottom: 15px; font-size: 48px;">üî•</div>
                        <h4>Arraste o arquivo Excel aqui ou clique para selecionar</h4>
                        <p style="margin-top: 10px; color: #64748b;">Formatos aceitos: XLSX, XLS, CSV</p>
                        <p style="margin-top: 5px; color: #64748b; font-size: 14px;">
                            <strong>Formato:</strong> Coluna A = C√≥digo, Coluna B = CEP (sem cabe√ßalho)
                        </p>
                        <p style="margin-top: 10px; color: var(--success); font-size: 12px;">
                            ‚ö° Sincroniza√ß√£o instant√¢nea com todos os operadores via Firebase
                        </p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                    <div id="importPreview" class="import-preview hidden">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Pr√©via da Importa√ß√£o</h4>
                        <div id="previewContent"></div>
                        <div style="margin-top: 20px;">
                            <button onclick="confirmImport()" class="btn btn-success">üî• Confirmar e Sincronizar</button>
                            <button onclick="cancelImport()" class="btn btn-danger">Cancelar</button>
                        </div>
                    </div>
                </div>

                <!-- Pendentes Tab -->
                <div id="tab-pendentes" class="tab-content hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">üìã C√≥digos Pendentes</h3>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="searchPendentes" class="form-control" placeholder="Buscar c√≥digo..." style="max-width: 200px;">
                            <button onclick="exportPendentes()" class="btn btn-warning">Exportar Lista</button>
                        </div>
                    </div>
                    <div id="pendentesList" style="background: var(--white); border-radius: 12px; box-shadow: var(--shadow); padding: 20px;">
                        <p style="text-align: center; color: #64748b;">Carregando c√≥digos pendentes via Firebase...</p>
                    </div>
                </div>

                <!-- Lotes Tab -->
                <div id="tab-lotes" class="tab-content hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary);">üì¶ Lotes Conclu√≠dos</h3>
                        <button onclick="exportAllBatches()" class="btn btn-warning">Exportar Todos os Lotes</button>
                    </div>
                    <div id="lotesList" style="background: var(--white); border-radius: 12px; box-shadow: var(--shadow); padding: 20px;">
                        <p style="text-align
