<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Bipagem Ultra-R√°pido | GitHub Pages</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --duplicate: #8b5cf6;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #111827;
            color: #f3f4f6;
            --light: #1f2937;
            --white: #374151;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .login-box {
            background: var(--white);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            text-align: center;
            font-size: 2em;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: var(--error);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .header {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title {
            font-size: 1.5em;
            color: var(--primary);
            font-weight: 700;
        }

        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95em;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .main-content {
                grid-template-columns: 2fr 1fr;
            }
        }

        .panel {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .panel-title {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: var(--dark);
            font-weight: 600;
        }

        /* Scanner Input */
        .scanner-section {
            text-align: center;
        }

        .scanner-input {
            width: 100%;
            padding: 20px;
            font-size: 24px;
            text-align: center;
            border: 3px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 30px;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .scanner-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* Result Display */
        .result-display {
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 30px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            transition: all 0.3s;
        }

        .result-success {
            background: var(--success);
            color: white;
        }

        .result-error {
            background: var(--error);
            color: white;
        }

        .result-warning {
            background: var(--warning);
            color: white;
        }

        .result-duplicate {
            background: var(--duplicate);
            color: white;
        }

        .result-neutral {
            background: var(--light);
            color: var(--dark);
            border: 2px dashed #d1d5db;
        }

        .result-detail {
            font-size: 0.7em;
            margin-top: 10px;
            opacity: 0.9;
        }

        /* History */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .history-item:hover {
            background: var(--light);
        }

        .history-success {
            border-left: 4px solid var(--success);
        }

        .history-error {
            border-left: 4px solid var(--error);
        }

        .history-warning {
            border-left: 4px solid var(--warning);
        }

        .history-duplicate {
            border-left: 4px solid var(--duplicate);
        }

        .history-code {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .history-time {
            color: #6b7280;
            font-size: 0.85em;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }

        /* CEP Config */
        .cep-config {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .cep-input {
            flex: 1;
            min-width: 200px;
        }

        .cep-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .cep-tag {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cep-remove {
            cursor: pointer;
            font-weight: bold;
        }

        /* Supervisor Dashboard */
        .supervisor-container {
            display: none;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-close:hover {
            color: var(--dark);
        }

        /* File Upload */
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: #dbeafe;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dark mode toggle */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }

        /* Sound Toggle */
        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #cbd5e1;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(25px);
        }

        /* Lotes */
        .lote-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .lote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .lote-title {
            font-weight: 600;
            font-size: 1.1em;
        }

        .lote-count {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .lote-codes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .lote-code-item {
            background: var(--light);
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .panel {
                padding: 20px;
            }

            .scanner-input {
                font-size: 18px;
                padding: 15px;
            }

            .result-display {
                font-size: 1.2em;
                padding: 30px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1 class="login-title">üöÄ Bipagem Ultra-R√°pido</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">üë§ Matr√≠cula</label>
                    <input type="text" id="matricula" class="form-input" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">üîê Senha</label>
                    <input type="password" id="senha" class="form-input" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn">Entrar</button>
            </form>
            <div id="loginError" style="color: var(--error); text-align: center; margin-top: 20px; display: none;"></div>
        </div>
    </div>

    <!-- Operator App -->
    <div id="appScreen" class="app-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <h1 class="header-title">üöÄ Bipagem Ultra-R√°pido | GitHub Pages</h1>
                    <div class="header-info">
                        <div class="header-item">
                            <span>üë®‚Äçüíº</span>
                            <span id="operatorName">-</span>
                            <span id="operatorId">-</span>
                        </div>
                        <div class="header-item">
                            <span>üìç CEPs:</span>
                            <span id="currentCep">N√£o configurado</span>
                        </div>
                        <div class="header-item">
                            <span>üïê</span>
                            <span id="currentTime">-</span>
                        </div>
                        <button class="btn" onclick="logout()" style="width: auto; padding: 8px 16px; font-size: 14px;">Sair</button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Left Panel - Scanner -->
                <div class="panel">
                    <h2 class="panel-title">üì¶ Valida√ß√£o de C√≥digos</h2>
                    
                    <!-- CEP Configuration -->
                    <div class="cep-config">
                        <input type="text" id="cepInput" class="form-input cep-input" placeholder="Digite o CEP da gaiola" maxlength="9">
                        <button class="btn" onclick="addCep()" style="width: auto;">Adicionar CEP</button>
                    </div>
                    <div id="cepList" class="cep-list"></div>
                    
                    <!-- Complete CEP Button -->
                    <div id="completeCepSection" style="display: none; margin: 20px 0;">
                        <button class="btn btn-success" onclick="completeCep()" style="width: 100%; background: var(--success);">
                            ‚úÖ Concluir CEP e Iniciar Novo
                        </button>
                    </div>

                    <!-- Sound Toggle -->
                    <div class="sound-toggle">
                        <span>üîä Sons:</span>
                        <div class="toggle-switch active" id="soundToggle" onclick="toggleSound()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <!-- Scanner Input -->
                    <div class="scanner-section">
                        <input 
                            type="text" 
                            id="scannerInput" 
                            class="scanner-input" 
                            placeholder="Aguardando c√≥digo..."
                            disabled
                        >
                        
                        <!-- Result Display -->
                        <div id="resultDisplay" class="result-display result-neutral">
                            <span>Pronto para iniciar</span>
                        </div>
                    </div>

                    <!-- History -->
                    <h3 class="panel-title">üìã Hist√≥rico Recente</h3>
                    <div id="historyList" class="history-list">
                        <p style="text-align: center; color: #6b7280;">Nenhuma valida√ß√£o ainda</p>
                    </div>
                </div>

                <!-- Right Panel - Statistics -->
                <div class="panel">
                    <h2 class="panel-title">üìä Estat√≠sticas da Sess√£o</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotal">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-card" style="background: rgba(34, 197, 94, 0.1);">
                            <div class="stat-value" id="statCorrect" style="color: var(--success);">0</div>
                            <div class="stat-label">‚úÖ Corretos</div>
                        </div>
                        <div class="stat-card" style="background: rgba(239, 68, 68, 0.1);">
                            <div class="stat-value" id="statError" style="color: var(--error);">0</div>
                            <div class="stat-label">‚ùå Errados</div>
                        </div>
                        <div class="stat-card" style="background: rgba(139, 92, 246, 0.1);">
                            <div class="stat-value" id="statDuplicate" style="color: var(--duplicate);">0</div>
                            <div class="stat-label">üîÑ Duplicados</div>
                        </div>
                        <div class="stat-card" style="background: rgba(245, 158, 11, 0.1);">
                            <div class="stat-value" id="statNotFound" style="color: var(--warning);">0</div>
                            <div class="stat-label">üîç N√£o Encontrados</div>
                        </div>
                    </div>

                    <div class="stats-grid" style="margin-top: 30px;">
                        <div class="stat-card">
                            <div class="stat-value" id="statAccuracy">0%</div>
                            <div class="stat-label">Taxa de Acerto</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statAvgTime">0ms</div>
                            <div class="stat-label">Tempo M√©dio</div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="syncData()" style="width: 100%; margin-bottom: 10px;">
                            üîÑ Sincronizar Dados
                        </button>
                        <button class="btn" onclick="exportLogs()" style="width: 100%; background: #6b7280;">
                            üì• Exportar Logs
                        </button>
                    </div>

                    <!-- Loading indicator -->
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supervisor Dashboard -->
    <div id="supervisorScreen" class="supervisor-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <h1 class="header-title">üìä Dashboard Supervisor | Bipagem Ultra-R√°pido</h1>
                    <div class="header-info">
                        <div class="header-item">
                            <span>üë®‚Äçüíº</span>
                            <span id="supervisorName">-</span>
                        </div>
                        <div class="header-item">
                            <span>üïê</span>
                            <span id="supervisorTime">-</span>
                        </div>
                        <button class="btn" onclick="logout()" style="width: auto; padding: 8px 16px; font-size: 14px;">Sair</button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="tab" onclick="switchTab('operators')">üë• Operadores</button>
                <button class="tab" onclick="switchTab('import')">üì¶ Importar C√≥digos</button>
                <button class="tab" onclick="switchTab('lotes')">üìç Separa√ß√£o por Lotes</button>
            </div>

            <!-- Tab Contents -->
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="panel">
                        <h2 class="panel-title">üìä Distribui√ß√£o de Valida√ß√µes</h2>
                        <div class="chart-container">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                    <div class="panel">
                        <h2 class="panel-title">üìà Estat√≠sticas Gerais</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="dashTotal">0</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="dashSuccess">0</div>
                                <div class="stat-label">‚úÖ Sucesso</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="dashError">0</div>
                                <div class="stat-label">‚ùå Erros</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="dashDuplicate">0</div>
                                <div class="stat-label">üîÑ Duplicados</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <p><strong>üì¶ Total de c√≥digos no sistema:</strong> <span id="totalSystemCodes">0</span></p>
                            <p><strong>‚úÖ C√≥digos validados hoje:</strong> <span id="totalValidatedToday">0</span></p>
                            <p><strong>‚è≥ C√≥digos pendentes:</strong> <span id="totalPendingCodes">0</span></p>
                        </div>
                        <button class="btn btn-danger" onclick="resetDailyData()" style="width: 100%; margin-top: 20px;">
                            üîÑ Resetar Dados do Dia
                        </button>
                    </div>
                </div>

                <!-- Active Operators -->
                <div class="panel" style="margin-top: 20px;">
                    <h2 class="panel-title">üë∑ Operadores Ativos</h2>
                    <div id="activeOperatorsList"></div>
                </div>
                
                <!-- Pending Codes -->
                <div class="panel" style="margin-top: 20px;">
                    <h2 class="panel-title">üìã C√≥digos N√£o Validados</h2>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="searchPendingCodes" class="form-input" placeholder="Buscar c√≥digo..." style="max-width: 300px;">
                        <button class="btn" onclick="exportPendingCodes()" style="width: auto; margin-left: 10px;">
                            üì• Exportar Pendentes
                        </button>
                    </div>
                    <div id="pendingCodesList" style="max-height: 400px; overflow-y: auto;">
                        <p style="text-align: center; color: #6b7280;">Carregando...</p>
                    </div>
                </div>
            </div>

            <!-- Operators Tab -->
            <div id="operatorsTab" class="tab-content">
                <div class="panel">
                    <h2 class="panel-title">üë• Gerenciar Operadores</h2>
                    <button class="btn" onclick="showAddOperatorModal()" style="width: auto; margin-bottom: 20px;">
                        ‚ûï Adicionar Novo Operador
                    </button>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Matr√≠cula</th>
                                <th>Nome</th>
                                <th>Senha</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="operatorsTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Import Tab -->
            <div id="importTab" class="tab-content">
                <div class="panel">
                    <h2 class="panel-title">üì¶ Importa√ß√£o Di√°ria de C√≥digos</h2>
                    <div style="margin-bottom: 20px;">
                        <p><strong>üìÖ √öltima importa√ß√£o:</strong> <span id="lastImportDate">Nunca</span></p>
                        <p><strong>üìä Total de c√≥digos ativos:</strong> <span id="totalCodesCount">0</span></p>
                    </div>
                    
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                        <p style="font-size: 1.2em; margin-bottom: 10px;">üìé Arraste o arquivo aqui</p>
                        <p style="color: #6b7280;">ou</p>
                        <button class="btn" onclick="document.getElementById('fileInput').click()" style="width: auto; margin-top: 10px;">
                            Selecionar Arquivo
                        </button>
                        <p style="color: #6b7280; font-size: 0.9em; margin-top: 20px;">
                            Formatos aceitos: CSV, Excel (XLSX, XLS)
                        </p>
                    </div>

                    <div id="importPreview" style="display: none; margin-top: 20px;">
                        <h3>üìã Preview da Importa√ß√£o:</h3>
                        <p>‚úÖ <span id="validCodesCount">0</span> c√≥digos v√°lidos</p>
                        <p>‚ùå <span id="invalidCodesCount">0</span> c√≥digos inv√°lidos</p>
                        <div style="margin-top: 20px;">
                            <button class="btn" onclick="confirmImport()">Confirmar Importa√ß√£o</button>
                            <button class="btn btn-secondary" onclick="cancelImport()" style="margin-left: 10px;">Cancelar</button>
                        </div>
                    </div>

                    <div class="loading" id="importLoading">
                        <div class="spinner"></div>
                        <p>Processando arquivo...</p>
                    </div>

                    <div style="margin-top: 30px; padding: 20px; background: #fef3c7; border-radius: 8px;">
                        <p style="color: #92400e; font-weight: 600;">‚ö†Ô∏è ATEN√á√ÉO:</p>
                        <p style="color: #92400e;">A importa√ß√£o substitui TODOS os c√≥digos anteriores!</p>
                    </div>
                </div>
            </div>

            <!-- Lotes Tab -->
            <div id="lotesTab" class="tab-content">
                <div class="panel">
                    <h2 class="panel-title">üìç Separa√ß√£o por Lotes</h2>
                    <p style="margin-bottom: 20px;">C√≥digos validados organizados automaticamente por CEP:</p>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn" onclick="exportAllLotes()" style="margin-right: 10px;">
                            üì• Exportar Todos os Lotes
                        </button>
                        <button class="btn btn-secondary" onclick="updateLotesDisplay()">
                            üîÑ Atualizar
                        </button>
                    </div>
                    
                    <div id="lotesList">
                        <p style="text-align: center; color: #6b7280;">Nenhum lote conclu√≠do ainda</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Operator Modal -->
    <div id="addOperatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Adicionar Novo Operador</h2>
                <span class="modal-close" onclick="closeAddOperatorModal()">&times;</span>
            </div>
            <form id="addOperatorForm">
                <div class="form-group">
                    <label class="form-label">Matr√≠cula</label>
                    <input type="text" id="newMatricula" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" id="newNome" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" id="newSenha" class="form-input" required>
                </div>
                <button type="submit" class="btn">Salvar</button>
            </form>
        </div>
    </div>

    <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">
        <span id="darkModeIcon">üåô</span>
    </button>

    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Global Variables
        let codesData = {};
        let operatorsData = {};
        let currentOperator = null;
        let selectedCeps = [];
        let sessionStats = {
            total: 0,
            correct: 0,
            error: 0,
            duplicate: 0,
            notFound: 0,
            times: []
        };
        let history = [];
        let codigosBipados = {};
        let soundEnabled = true;
        let importedData = null;
        let pieChart = null;

        // Audio Context for beeps
        let audioContext = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Load operators data
            await loadOperatorsData();
            
            // Check for saved session
            const savedSession = localStorage.getItem('bipagem_session');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                if (session.operator && new Date() - new Date(session.timestamp) < 8 * 60 * 60 * 1000) {
                    currentOperator = session.operator;
                    if (currentOperator.perfil === 'supervisor') {
                        await showSupervisorDashboard();
                    } else {
                        await showApp();
                    }
                }
            }

            // Update time
            setInterval(updateTime, 1000);
            updateTime();

            // Dark mode
            if (window.matchMedia('(prefers-color-scheme: dark)').matches || 
                new Date().getHours() >= 20 || new Date().getHours() < 6) {
                toggleDarkMode();
            }

            // Setup file upload
            setupFileUpload();
            
            // Listen for code updates
            window.addEventListener('storage', (e) => {
                if (e.key === 'bipagem_codes_updated') {
                    // Reload codes when supervisor imports new data
                    loadCodesData();
                    if (currentOperator && currentOperator.perfil !== 'supervisor') {
                        alert('Novos c√≥digos foram importados! Sistema atualizado.');
                    }
                }
            });
        });
                        await showApp();
                    }
                }
            }

            // Update time
            setInterval(updateTime, 1000);
            updateTime();

            // Dark mode
            if (window.matchMedia('(prefers-color-scheme: dark)').matches || 
                new Date().getHours() >= 20 || new Date().getHours() < 6) {
                toggleDarkMode();
            }

            // Setup file upload
            setupFileUpload();
        });

        // Load operators data
        async function loadOperatorsData() {
            try {
                // For demo purposes, using embedded data
                operatorsData = {
                    "1234": { "nome": "Jo√£o Silva", "senha": "1234", "perfil": "operador" },
                    "5678": { "nome": "Maria Santos", "senha": "5678", "perfil": "operador" },
                    "9999": { "nome": "Carlos Supervisor", "senha": "9999", "perfil": "supervisor" },
                    "1111": { "nome": "Ana Costa", "senha": "1111", "perfil": "operador" },
                    "2222": { "nome": "Pedro Mendes", "senha": "2222", "perfil": "operador" }
                };
                
                // In production, load from operadores.json
                // const response = await fetch('operadores.json');
                // const data = await response.json();
                // operatorsData = data.operators;
                
                // Load from localStorage if exists
                const savedOperators = localStorage.getItem('bipagem_operators');
                if (savedOperators) {
                    operatorsData = JSON.parse(savedOperators);
                }
            } catch (error) {
                console.error('Error loading operators:', error);
            }
        }

        // Load codes data
        async function loadCodesData() {
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Check for imported data first
                const importedCodes = localStorage.getItem('bipagem_imported_codes');
                if (importedCodes) {
                    const imported = JSON.parse(importedCodes);
                    codesData = imported.codes;
                    document.getElementById('lastImportDate').textContent = new Date(imported.timestamp).toLocaleString('pt-BR');
                    document.getElementById('totalCodesCount').textContent = Object.keys(codesData).length;
                } else {
                    // For demo purposes, using embedded data
                    codesData = {
                        "BR259747338411J": "36960000",
                        "BR253223789688Z": "36950000",
                        "BR258554089877H": "35300114",
                        "BR251547397372A": "35300352",
                        "BR250479272632K": "35350000",
                        "BR252995453810J": "35334000",
                        "BR258009821176I": "35324000",
                        "BR250679813958H": "36985000",
                        "BR255038998529P": "35325000",
                        "BR255021795505T": "35323000",
                        "BR250975639954M": "35330000",
                        "BR254999675182G": "36955000",
                        "BR253288681003L": "35300238",
                        "BR258650626221K": "35300206",
                        "BR252376322316V": "35330000",
                        "BR254192166075H": "36955000",
                        "BR257915739529H": "35300333",
                        "BR259720647109B": "36950000",
                        "BR257312724687K": "36950000",
                        "BR251568951275J": "35350000",
                        "BR256418899822C": "35350000",
                        "BR250437397695I": "36955000",
                        "BR254664600882L": "36955000",
                        "BR251858464207E": "35330000",
                        "BR254916621112D": "36950000",
                        "BR253375879177S": "35300145",
                        "BR253841771153P": "35300167"
                    };
                }
                
                localStorage.setItem('bipagem_codes', JSON.stringify({
                    data: codesData,
                    timestamp: new Date().toISOString()
                }));
                
                // Load bipados data
                const savedBipados = localStorage.getItem('bipagem_bipados');
                if (savedBipados) {
                    const bipados = JSON.parse(savedBipados);
                    // Only load if from today
                    if (new Date().toDateString() === new Date(bipados.date).toDateString()) {
                        codigosBipados = bipados.codigos;
                    }
                }
                
            } catch (error) {
                console.error('Error loading codes:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const matricula = document.getElementById('matricula').value;
            const senha = document.getElementById('senha').value;
            const errorDiv = document.getElementById('loginError');
            
            if (operatorsData[matricula] && operatorsData[matricula].senha === senha) {
                currentOperator = {
                    matricula: matricula,
                    ...operatorsData[matricula]
                };
                
                localStorage.setItem('bipagem_session', JSON.stringify({
                    operator: currentOperator,
                    timestamp: new Date().toISOString()
                }));
                
                if (currentOperator.perfil === 'supervisor') {
                    await showSupervisorDashboard();
                } else {
                    await showApp();
                }
            } else {
                errorDiv.textContent = 'Matr√≠cula ou senha inv√°lida';
                errorDiv.style.display = 'block';
            }
        });

        // Show App (Operator)
        async function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            document.getElementById('supervisorScreen').style.display = 'none';
            
            // Update operator info
            document.getElementById('operatorName').textContent = currentOperator.nome;
            document.getElementById('operatorId').textContent = `(${currentOperator.matricula})`;
            
            // Load codes
            await loadCodesData();
            
            // Initialize audio
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Setup scanner input
            const scannerInput = document.getElementById('scannerInput');
            scannerInput.addEventListener('input', handleScan);
            
            // Load saved stats
            const savedStats = localStorage.getItem('bipagem_stats_' + currentOperator.matricula);
            if (savedStats) {
                const stats = JSON.parse(savedStats);
                if (new Date().toDateString() === new Date(stats.date).toDateString()) {
                    sessionStats = stats.stats;
                    history = stats.history || [];
                    updateStats();
                    updateHistory();
                }
            }
            
            // Load saved CEPs
            const savedCeps = localStorage.getItem('bipagem_selected_ceps_' + currentOperator.matricula);
            if (savedCeps) {
                selectedCeps = JSON.parse(savedCeps);
                updateCepList();
                if (selectedCeps.length > 0) {
                    document.getElementById('scannerInput').disabled = false;
                }
            }
        }

        // Show Supervisor Dashboard
        async function showSupervisorDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'none';
            document.getElementById('supervisorScreen').style.display = 'block';
            
            // Update supervisor info
            document.getElementById('supervisorName').textContent = currentOperator.nome;
            
            // Load codes
            await loadCodesData();
            
            // Load dashboard data
            loadDashboardData();
            
            // Load operators table
            loadOperatorsTable();
            
            // Setup chart
            setupChart();
            
            // Update dashboard every 2 seconds (faster update)
            setInterval(loadDashboardData, 2000);
        }

        // Add CEP
        function addCep() {
            const input = document.getElementById('cepInput');
            let cep = input.value.replace(/\D/g, '');
            
            // Aceita CEP com ou sem h√≠fen
            if (cep.length === 8 && !selectedCeps.includes(cep)) {
                selectedCeps.push(cep);
                updateCepList();
                input.value = '';
                
                // Salva CEPs selecionados
                localStorage.setItem('bipagem_selected_ceps_' + currentOperator.matricula, JSON.stringify(selectedCeps));
                
                // Enable scanner
                if (selectedCeps.length > 0) {
                    document.getElementById('scannerInput').disabled = false;
                    document.getElementById('scannerInput').focus();
                }
            } else if (selectedCeps.includes(cep)) {
                alert('Este CEP j√° foi adicionado!');
            } else if (cep.length !== 8) {
                alert('CEP deve ter 8 d√≠gitos!');
            }
        }

        // Update CEP list
        function updateCepList() {
            const container = document.getElementById('cepList');
            const currentCepDisplay = document.getElementById('currentCep');
            
            container.innerHTML = selectedCeps.map(cep => `
                <div class="cep-tag">
                    ${formatCep(cep)}
                    <span class="cep-remove" onclick="removeCep('${cep}')">√ó</span>
                </div>
            `).join('');
            
            currentCepDisplay.textContent = selectedCeps.length > 0 
                ? selectedCeps.map(formatCep).join(', ')
                : 'N√£o configurado';
        }

        // Remove CEP
        function removeCep(cep) {
            selectedCeps = selectedCeps.filter(c => c !== cep);
            updateCepList();
            
            if (selectedCeps.length === 0) {
                document.getElementById('scannerInput').disabled = true;
            }
        }

        // Format CEP
        function formatCep(cep) {
            return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
        }

        // Handle scan
        async function handleScan(e) {
            const code = e.target.value.trim();
            
            if (code.length >= 13) { // Minimum code length
                const startTime = performance.now();
                
                // Clear input immediately
                e.target.value = '';
                
                // Validate code
                const result = validateCode(code);
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                // Update display
                showResult(result, code, responseTime);
                
                // Update stats
                updateSessionStats(result.status, responseTime);
                
                // Add to history
                addToHistory(code, result, responseTime);
                
                // Play sound
                if (soundEnabled) {
                    playSound(result.status);
                }
                
                // Vibrate if available
                if ('vibrate' in navigator) {
                    if (result.status === 'success') {
                        navigator.vibrate(50);
                    } else if (result.status === 'duplicate') {
                        navigator.vibrate([50, 50, 50]);
                    } else {
                        navigator.vibrate([100, 50, 100]);
                    }
                }
                
                // Log
                logValidation(code, result, responseTime);
                
                // Update dashboard if needed
                updateDashboardRealtime();
            }
        }

        // Validate code
        function validateCode(code) {
            // First check if duplicate
            if (codigosBipados[code]) {
                return {
                    status: 'duplicate',
                    message: `DUPLICADO! J√° validado √†s ${formatTime(codigosBipados[code].timestamp)} por ${codigosBipados[code].operador}`,
                    originalData: codigosBipados[code]
                };
            }
            
            const cep = codesData[code];
            
            if (!cep) {
                return { status: 'notFound', message: 'N√ÉO ENCONTRADO' };
            }
            
            if (selectedCeps.includes(cep)) {
                // Save as bipado
                codigosBipados[code] = {
                    timestamp: new Date(),
                    operador: `${currentOperator.nome} (${currentOperator.matricula})`,
                    cep: cep,
                    resultado: 'success'
                };
                saveBipados();
                
                return { status: 'success', message: 'CORRETO!' };
            }
            
            return { 
                status: 'error', 
                message: `ERRADO! CEP: ${formatCep(cep)}` 
            };
        }

        // Show result
        function showResult(result, code, time) {
            const display = document.getElementById('resultDisplay');
            
            // Remove all result classes
            display.classList.remove('result-success', 'result-error', 'result-warning', 'result-duplicate', 'result-neutral');
            
            // Add appropriate class
            switch (result.status) {
                case 'success':
                    display.classList.add('result-success');
                    display.innerHTML = `‚úÖ ${result.message} (${time}ms)`;
                    break;
                case 'error':
                    display.classList.add('result-error');
                    display.innerHTML = `‚ùå ${result.message} (${time}ms)`;
                    break;
                case 'duplicate':
                    display.classList.add('result-duplicate');
                    display.innerHTML = `
                        <div>üîÑ DUPLICADO!</div>
                        <div class="result-detail">${result.message}</div>
                        <div style="font-size: 0.6em; margin-top: 5px;">(${time}ms)</div>
                    `;
                    break;
                case 'notFound':
                    display.classList.add('result-warning');
                    display.innerHTML = `üîç ${result.message} (${time}ms)`;
                    break;
            }
            
            // Reset after 3 seconds
            setTimeout(() => {
                display.classList.remove('result-success', 'result-error', 'result-warning', 'result-duplicate');
                display.classList.add('result-neutral');
                display.innerHTML = 'Aguardando pr√≥ximo c√≥digo...';
            }, 3000);
        }

        // Play sound with different tones
        function playSound(status) {
            if (!audioContext || !soundEnabled) return;
            
            const now = audioContext.currentTime;
            
            switch (status) {
                case 'success':
                    // High pitch short beep
                    createBeep(800, 0.1, 'sine');
                    break;
                    
                case 'error':
                    // Low pitch longer beep
                    createBeep(300, 0.3, 'square');
                    break;
                    
                case 'duplicate':
                    // Two quick beeps
                    createBeep(600, 0.1, 'triangle');
                    setTimeout(() => createBeep(600, 0.1, 'triangle'), 150);
                    break;
                    
                case 'notFound':
                    // Ascending tone
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.setValueAtTime(400, now);
                    oscillator.frequency.linearRampToValueAtTime(600, now + 0.2);
                    gainNode.gain.value = 0.3;
                    oscillator.start(now);
                    oscillator.stop(now + 0.2);
                    break;
            }
        }

        // Create beep helper
        function createBeep(frequency, duration, type = 'sine') {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            gainNode.gain.value = 0.3;
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Toggle sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const toggle = document.getElementById('soundToggle');
            if (soundEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        // Update session stats
        function updateSessionStats(status, time) {
            sessionStats.total++;
            sessionStats.times.push(time);
            
            switch (status) {
                case 'success':
                    sessionStats.correct++;
                    break;
                case 'error':
                    sessionStats.error++;
                    break;
                case 'duplicate':
                    sessionStats.duplicate++;
                    break;
                case 'notFound':
                    sessionStats.notFound++;
                    break;
            }
            
            updateStats();
            saveStats();
        }

        // Complete CEP
        function completeCep() {
            if (selectedCeps.length === 0) {
                alert('Nenhum CEP para concluir!');
                return;
            }
            
            if (confirm(`Deseja concluir o(s) CEP(s) ${selectedCeps.map(formatCep).join(', ')} e iniciar novo?`)) {
                // Save completed CEPs
                const completedCeps = JSON.parse(localStorage.getItem('bipagem_completed_ceps') || '[]');
                const timestamp = new Date().toISOString();
                
                selectedCeps.forEach(cep => {
                    completedCeps.push({
                        cep: cep,
                        operator: currentOperator.nome,
                        matricula: currentOperator.matricula,
                        timestamp: timestamp,
                        codes: Object.entries(codigosBipados)
                            .filter(([code, data]) => data.cep === cep)
                            .map(([code, data]) => code)
                    });
                });
                
                localStorage.setItem('bipagem_completed_ceps', JSON.stringify(completedCeps));
                
                // Reset for new CEP
                selectedCeps = [];
                updateCepList();
                document.getElementById('scannerInput').disabled = true;
                document.getElementById('scannerInput').value = '';
                document.getElementById('resultDisplay').className = 'result-display result-neutral';
                document.getElementById('resultDisplay').innerHTML = 'Pronto para iniciar';
                document.getElementById('completeCepSection').style.display = 'none';
                
                // Clear local storage for CEPs
                localStorage.removeItem('bipagem_selected_ceps_' + currentOperator.matricula);
                
                alert('CEP conclu√≠do com sucesso! Adicione um novo CEP para continuar.');
                document.getElementById('cepInput').focus();
            }
        }

        // Update stats display with complete button
        function updateStats() {
            document.getElementById('statTotal').textContent = sessionStats.total;
            document.getElementById('statCorrect').textContent = sessionStats.correct;
            document.getElementById('statError').textContent = sessionStats.error;
            document.getElementById('statDuplicate').textContent = sessionStats.duplicate;
            document.getElementById('statNotFound').textContent = sessionStats.notFound;
            
            // Calculate accuracy
            const accuracy = sessionStats.total > 0 
                ? Math.round((sessionStats.correct / sessionStats.total) * 100)
                : 0;
            document.getElementById('statAccuracy').textContent = accuracy + '%';
            
            // Calculate average time
            const avgTime = sessionStats.times.length > 0
                ? Math.round(sessionStats.times.reduce((a, b) => a + b, 0) / sessionStats.times.length)
                : 0;
            document.getElementById('statAvgTime').textContent = avgTime + 'ms';
            
            // Show complete button if there are successful validations
            if (sessionStats.correct > 0 && selectedCeps.length > 0) {
                document.getElementById('completeCepSection').style.display = 'block';
            }
        }

        // Add to history
        function addToHistory(code, result, time) {
            const historyItem = {
                code: code,
                result: result,
                time: time,
                timestamp: new Date()
            };
            
            history.unshift(historyItem);
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            
            updateHistory();
        }

        // Update history display
        function updateHistory() {
            const container = document.getElementById('historyList');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Nenhuma valida√ß√£o ainda</p>';
                return;
            }
            
            container.innerHTML = history.map(item => {
                let statusClass = '';
                let statusIcon = '';
                
                switch (item.result.status) {
                    case 'success':
                        statusClass = 'history-success';
                        statusIcon = '‚úÖ';
                        break;
                    case 'error':
                        statusClass = 'history-error';
                        statusIcon = '‚ùå';
                        break;
                    case 'duplicate':
                        statusClass = 'history-duplicate';
                        statusIcon = 'üîÑ';
                        break;
                    case 'notFound':
                        statusClass = 'history-warning';
                        statusIcon = 'üîç';
                        break;
                }
                
                return `
                    <div class="history-item ${statusClass}">
                        <div>
                            <span>${statusIcon}</span>
                            <span class="history-code">${item.code}</span>
                            <span style="color: #6b7280; font-size: 0.85em;">
                                ${item.result.status === 'error' ? item.result.message : ''}
                                ${item.result.status === 'duplicate' ? '(Duplicado)' : ''}
                            </span>
                        </div>
                        <div>
                            <span style="color: #6b7280; font-size: 0.85em;">(${item.time}ms)</span>
                            <span class="history-time">${formatTime(item.timestamp)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Save stats
        function saveStats() {
            localStorage.setItem('bipagem_stats_' + currentOperator.matricula, JSON.stringify({
                date: new Date().toISOString(),
                stats: sessionStats,
                history: history
            }));
        }

        // Save bipados
        function saveBipados() {
            localStorage.setItem('bipagem_bipados', JSON.stringify({
                date: new Date().toISOString(),
                codigos: codigosBipados
            }));
        }

        // Log validation
        function logValidation(code, result, time) {
            const logs = JSON.parse(localStorage.getItem('bipagem_logs') || '[]');
            
            logs.push({
                timestamp: new Date().toISOString(),
                operator: currentOperator.matricula,
                operatorName: currentOperator.nome,
                code: code,
                result: result.status,
                message: result.message,
                responseTime: time,
                ceps: selectedCeps
            });
            
            // Keep only last 5000 logs
            if (logs.length > 5000) {
                logs.splice(0, logs.length - 5000);
            }
            
            localStorage.setItem('bipagem_logs', JSON.stringify(logs));
        }

        // Export logs
        function exportLogs() {
            const logs = localStorage.getItem('bipagem_logs') || '[]';
            const blob = new Blob([logs], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bipagem_logs_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Sync data
        async function syncData() {
            document.getElementById('loading').style.display = 'block';
            
            try {
                await loadCodesData();
                alert('Dados sincronizados com sucesso!');
            } catch (error) {
                alert('Erro ao sincronizar dados: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Logout
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('bipagem_session');
                currentOperator = null;
                selectedCeps = [];
                sessionStats = {
                    total: 0,
                    correct: 0,
                    error: 0,
                    duplicate: 0,
                    notFound: 0,
                    times: []
                };
                history = [];
                
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('supervisorScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('loginForm').reset();
            }
        }

        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('darkModeIcon');
            icon.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
        }

        // Update time
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('supervisorTime').textContent = timeString;
        }

        // Format time
        function formatTime(date) {
            return new Date(date).toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Keep focus on scanner input
        setInterval(() => {
            const scannerInput = document.getElementById('scannerInput');
            if (document.getElementById('appScreen').style.display !== 'none' && 
                !scannerInput.disabled && 
                document.activeElement !== scannerInput) {
                scannerInput.focus();
            }
        }, 100);

        // Handle Enter key on CEP input
        document.getElementById('cepInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCep();
            }
        });

        // Format CEP input
        document.getElementById('cepInput').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            e.target.value = value;
        });

        // Prevent form resubmission
        window.addEventListener('beforeunload', (e) => {
            if (sessionStats.total > 0) {
                saveStats();
            }
        });

        // SUPERVISOR FUNCTIONS

        // Switch tabs
        function switchTab(tabName) {
            // Remove active from all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active to clicked tab
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Load dashboard data
        function loadDashboardData() {
            const logs = JSON.parse(localStorage.getItem('bipagem_logs') || '[]');
            const todayLogs = logs.filter(log => 
                new Date(log.timestamp).toDateString() === new Date().toDateString()
            );
            
            // Calculate stats
            const stats = {
                total: todayLogs.length,
                success: todayLogs.filter(log => log.result === 'success').length,
                error: todayLogs.filter(log => log.result === 'error').length,
                duplicate: todayLogs.filter(log => log.result === 'duplicate').length,
                notFound: todayLogs.filter(log => log.result === 'notFound').length
            };
            
            // Update dashboard stats
            document.getElementById('dashTotal').textContent = stats.total;
            document.getElementById('dashSuccess').textContent = stats.success;
            document.getElementById('dashError').textContent = stats.error;
            document.getElementById('dashDuplicate').textContent = stats.duplicate;
            
            // Update system totals
            const totalCodes = Object.keys(codesData).length;
            const validatedCodes = Object.keys(codigosBipados).length;
            const pendingCodes = totalCodes - validatedCodes;
            
            document.getElementById('totalSystemCodes').textContent = totalCodes;
            document.getElementById('totalValidatedToday').textContent = validatedCodes;
            document.getElementById('totalPendingCodes').textContent = pendingCodes;
            
            // Update chart
            if (pieChart) {
                pieChart.data.datasets[0].data = [
                    stats.success,
                    stats.error,
                    stats.duplicate,
                    stats.notFound
                ];
                pieChart.update();
            }
            
            // Update active operators
            updateActiveOperators(todayLogs);
            
            // Update lotes
            updateLotes(todayLogs);
            
            // Update pending codes
            updatePendingCodes();
        }

        // Setup chart
        function setupChart() {
            const ctx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['‚úÖ Sucesso', '‚ùå CEP Errado', 'üîÑ Duplicados', 'üîç N√£o Encontrados'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(139, 92, 246, 1)',
                            'rgba(245, 158, 11, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update active operators
        function updateActiveOperators(logs) {
            const operatorStats = {};
            
            logs.forEach(log => {
                if (!operatorStats[log.operatorName]) {
                    operatorStats[log.operatorName] = {
                        matricula: log.operator,
                        total: 0,
                        success: 0,
                        lastActivity: null
                    };
                }
                
                operatorStats[log.operatorName].total++;
                if (log.result === 'success') {
                    operatorStats[log.operatorName].success++;
                }
                operatorStats[log.operatorName].lastActivity = log.timestamp;
            });
            
            const container = document.getElementById('activeOperatorsList');
            const operators = Object.entries(operatorStats);
            
            if (operators.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Nenhum operador ativo hoje</p>';
                return;
            }
            
            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Operador</th>
                            <th>Matr√≠cula</th>
                            <th>Total</th>
                            <th>Taxa Acerto</th>
                            <th>√öltima Atividade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${operators.map(([name, stats]) => `
                            <tr>
                                <td>${name}</td>
                                <td>${stats.matricula}</td>
                                <td>${stats.total}</td>
                                <td>${Math.round((stats.success / stats.total) * 100)}%</td>
                                <td>${formatTime(stats.lastActivity)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Load operators table
        function loadOperatorsTable() {
            const tbody = document.getElementById('operatorsTableBody');
            const operators = Object.entries(operatorsData).filter(([_, data]) => data.perfil !== 'supervisor');
            
            tbody.innerHTML = operators.map(([matricula, data]) => `
                <tr>
                    <td>${matricula}</td>
                    <td>${data.nome}</td>
                    <td>****</td>
                    <td>
                        <button class="btn btn-danger" onclick="removeOperator('${matricula}')" style="width: auto; padding: 6px 12px; font-size: 14px;">
                            üóëÔ∏è Remover
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Show add operator modal
        function showAddOperatorModal() {
            document.getElementById('addOperatorModal').style.display = 'flex';
            document.getElementById('newMatricula').focus();
        }

        // Close add operator modal
        function closeAddOperatorModal() {
            document.getElementById('addOperatorModal').style.display = 'none';
            document.getElementById('addOperatorForm').reset();
        }

        // Add operator form
        document.getElementById('addOperatorForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const matricula = document.getElementById('newMatricula').value;
            const nome = document.getElementById('newNome').value;
            const senha = document.getElementById('newSenha').value;
            
            if (operatorsData[matricula]) {
                alert('Matr√≠cula j√° existe!');
                return;
            }
            
            operatorsData[matricula] = {
                nome: nome,
                senha: senha,
                perfil: 'operador'
            };
            
            localStorage.setItem('bipagem_operators', JSON.stringify(operatorsData));
            
            loadOperatorsTable();
            closeAddOperatorModal();
            
            alert('Operador adicionado com sucesso!');
        });

        // Remove operator
        function removeOperator(matricula) {
            if (confirm(`Deseja remover o operador ${operatorsData[matricula].nome}?`)) {
                delete operatorsData[matricula];
                localStorage.setItem('bipagem_operators', JSON.stringify(operatorsData));
                loadOperatorsTable();
                alert('Operador removido com sucesso!');
            }
        }

        // Setup file upload
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }

        // Handle file upload
        async function handleFileUpload(file) {
            document.getElementById('importLoading').style.display = 'block';
            document.getElementById('uploadArea').style.display = 'none';
            
            try {
                let data = [];
                
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    // Para XLSX, precisamos usar FileReader
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            // Simula√ß√£o de parse XLSX
                            // Em produ√ß√£o, voc√™ pode usar uma biblioteca como SheetJS
                            const text = e.target.result;
                            // Por enquanto, vamos aceitar o arquivo e mostrar uma mensagem
                            alert('Arquivo XLSX detectado. Em produ√ß√£o, use SheetJS para processar.');
                            
                            // Simulando dados para teste
                            const simulatedData = {
                                "BR258168720772V": "35300283",
                                "BR253301520381T": "35358000",
                                "BR250015549185Z": "36985000",
                                "BR252662640820Y": "35350000"
                            };
                            
                            importedData = simulatedData;
                            
                            // Show preview
                            document.getElementById('validCodesCount').textContent = Object.keys(simulatedData).length;
                            document.getElementById('invalidCodesCount').textContent = 0;
                            document.getElementById('importPreview').style.display = 'block';
                            document.getElementById('importLoading').style.display = 'none';
                            
                        } catch (error) {
                            alert('Erro ao processar XLSX: ' + error.message);
                            document.getElementById('importLoading').style.display = 'none';
                            document.getElementById('uploadArea').style.display = 'block';
                        }
                    };
                    reader.readAsText(file);
                    return;
                    
                } else if (file.name.endsWith('.csv')) {
                    // Parse CSV
                    const text = await file.text();
                    const lines = text.split('\n');
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            const [codigo, cep] = line.split(/[,;\t]/);
                            if (codigo && cep) {
                                data.push({ codigo: codigo.trim(), cep: cep.trim().replace(/\D/g, '') });
                            }
                        }
                    }
                } else {
                    alert('Por favor, use arquivos CSV ou XLSX');
                    document.getElementById('importLoading').style.display = 'none';
                    document.getElementById('uploadArea').style.display = 'block';
                    return;
                }
                
                // Validate data for CSV
                if (data.length > 0) {
                    const validCodes = {};
                    let invalidCount = 0;
                    
                    data.forEach(item => {
                        if (item.codigo && item.cep && item.cep.length === 8) {
                            validCodes[item.codigo] = item.cep;
                        } else {
                            invalidCount++;
                        }
                    });
                    
                    importedData = validCodes;
                    
                    // Show preview
                    document.getElementById('validCodesCount').textContent = Object.keys(validCodes).length;
                    document.getElementById('invalidCodesCount').textContent = invalidCount;
                    document.getElementById('importPreview').style.display = 'block';
                }
                
            } catch (error) {
                alert('Erro ao processar arquivo: ' + error.message);
                document.getElementById('uploadArea').style.display = 'block';
            } finally {
                document.getElementById('importLoading').style.display = 'none';
            }
        }

        // Update pending codes
        function updatePendingCodes() {
            const allCodes = Object.keys(codesData);
            const validatedCodes = Object.keys(codigosBipados);
            const pendingCodes = allCodes.filter(code => !validatedCodes.includes(code));
            
            const container = document.getElementById('pendingCodesList');
            const searchTerm = document.getElementById('searchPendingCodes')?.value?.toLowerCase() || '';
            
            if (pendingCodes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Todos os c√≥digos foram validados!</p>';
                return;
            }
            
            // Filter by search
            const filteredCodes = searchTerm 
                ? pendingCodes.filter(code => code.toLowerCase().includes(searchTerm))
                : pendingCodes.slice(0, 100); // Show first 100 if no search
            
            container.innerHTML = `
                <p style="margin-bottom: 10px;"><strong>Total pendentes: ${pendingCodes.length}</strong></p>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                    ${filteredCodes.map(code => `
                        <div style="background: #f3f4f6; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 0.85em;">
                            <div>${code}</div>
                            <div style="color: #6b7280; font-size: 0.8em;">CEP: ${formatCep(codesData[code])}</div>
                        </div>
                    `).join('')}
                </div>
                ${pendingCodes.length > 100 && !searchTerm ? '<p style="text-align: center; margin-top: 20px; color: #6b7280;">Use a busca para ver mais c√≥digos...</p>' : ''}
            `;
        }

        // Export pending codes
        function exportPendingCodes() {
            const allCodes = Object.keys(codesData);
            const validatedCodes = Object.keys(codigosBipados);
            const pendingCodes = allCodes.filter(code => !validatedCodes.includes(code));
            
            const exportData = pendingCodes.map(code => ({
                codigo: code,
                cep: codesData[code],
                cep_formatado: formatCep(codesData[code])
            }));
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `codigos_pendentes_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Search pending codes
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchPendingCodes');
            if (searchInput) {
                searchInput.addEventListener('input', updatePendingCodes);
            }
        });

        // Confirm import
        function confirmImport() {
            if (!importedData) return;
            
            codesData = importedData;
            
            // Save to localStorage
            localStorage.setItem('bipagem_imported_codes', JSON.stringify({
                codes: codesData,
                timestamp: new Date().toISOString()
            }));
            
            // Update display
            document.getElementById('lastImportDate').textContent = new Date().toLocaleString('pt-BR');
            document.getElementById('totalCodesCount').textContent = Object.keys(codesData).length;
            
            // Reset form
            cancelImport();
            
            // Notify all operators via localStorage event
            localStorage.setItem('bipagem_codes_updated', new Date().toISOString());
            
            alert('C√≥digos importados com sucesso! Os operadores j√° podem come√ßar a validar.');
        }

        // Cancel import
        function cancelImport() {
            importedData = null;
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        // Reset daily data
        function resetDailyData() {
            if (confirm('Deseja realmente resetar todos os dados do dia? Isso ir√°:\n\n- Limpar todos os c√≥digos bipados\n- Zerar estat√≠sticas\n- Limpar hist√≥ricos\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
                // Clear bipados
                codigosBipados = {};
                localStorage.removeItem('bipagem_bipados');
                
                // Clear all operator stats
                Object.keys(operatorsData).forEach(matricula => {
                    localStorage.removeItem('bipagem_stats_' + matricula);
                });
                
                // Clear logs
                localStorage.setItem('bipagem_logs', '[]');
                
                // Reload dashboard
                loadDashboardData();
                
                alert('Dados do dia resetados com sucesso!');
            }
        }

        // Update lotes
        function updateLotes(logs) {
            // This function now shows lotes from completed CEPs
            updateLotesDisplay();
        }
        
        // Update lotes display
        function updateLotesDisplay() {
            const completedCeps = JSON.parse(localStorage.getItem('bipagem_completed_ceps') || '[]');
            const container = document.getElementById('lotesList');
            
            if (completedCeps.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Nenhum lote conclu√≠do ainda</p>';
                return;
            }
            
            // Group by CEP
            const lotesByCep = {};
            completedCeps.forEach(item => {
                if (!lotesByCep[item.cep]) {
                    lotesByCep[item.cep] = {
                        codes: [],
                        operators: new Set(),
                        lastUpdate: item.timestamp
                    };
                }
                lotesByCep[item.cep].codes.push(...item.codes);
                lotesByCep[item.cep].operators.add(item.operator);
                if (new Date(item.timestamp) > new Date(lotesByCep[item.cep].lastUpdate)) {
                    lotesByCep[item.cep].lastUpdate = item.timestamp;
                }
            });
            
            container.innerHTML = Object.entries(lotesByCep).map(([cep, data]) => `
                <div class="lote-container">
                    <div class="lote-header">
                        <div>
                            <div class="lote-title">üìç CEP: ${formatCep(cep)}</div>
                            <div style="font-size: 0.85em; color: #6b7280;">
                                Operadores: ${Array.from(data.operators).join(', ')} | 
                                √öltima atualiza√ß√£o: ${formatTime(data.lastUpdate)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div class="lote-count">${data.codes.length} c√≥digos</div>
                            <button class="btn" onclick="exportSingleLote('${cep}')" style="width: auto; padding: 8px 16px; font-size: 14px;">
                                üì• Exportar
                            </button>
                        </div>
                    </div>
                    <div class="lote-codes">
                        ${data.codes.slice(0, 10).map(code => `
                            <div class="lote-code-item">${code}</div>
                        `).join('')}
                        ${data.codes.length > 10 ? `<div class="lote-code-item">... e mais ${data.codes.length - 10} c√≥digos</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Export single lote
        function exportSingleLote(cep) {
            const completedCeps = JSON.parse(localStorage.getItem('bipagem_completed_ceps') || '[]');
            const loteData = completedCeps.filter(item => item.cep === cep);
            
            if (loteData.length === 0) return;
            
            const allCodes = [];
            loteData.forEach(item => {
                allCodes.push(...item.codes);
            });
            
            // Remove duplicates
            const uniqueCodes = [...new Set(allCodes)];
            
            const exportData = {
                cep: cep,
                cep_formatado: formatCep(cep),
                total_codigos: uniqueCodes.length,
                data_exportacao: new Date().toISOString(),
                codigos: uniqueCodes.map(code => ({
                    codigo: code,
                    dados: codigosBipados[code] || null
                }))
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lote_${cep}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Export all lotes
        function exportAllLotes() {
            const completedCeps = JSON.parse(localStorage.getItem('bipagem_completed_ceps') || '[]');
            
            if (completedCeps.length === 0) {
                alert('Nenhum lote para exportar!');
                return;
            }
            
            // Group by CEP
            const lotesByCep = {};
            completedCeps.forEach(item => {
                if (!lotesByCep[item.cep]) {
                    lotesByCep[item.cep] = [];
                }
                lotesByCep[item.cep].push(...item.codes);
            });
            
            // Create export data organized by CEP
            const exportData = {
                data_exportacao: new Date().toISOString(),
                total_ceps: Object.keys(lotesByCep).length,
                total_codigos: Object.values(lotesByCep).flat().length,
                lotes_por_cep: {}
            };
            
            Object.entries(lotesByCep).forEach(([cep, codes]) => {
                const uniqueCodes = [...new Set(codes)];
                exportData.lotes_por_cep[cep] = {
                    cep_formatado: formatCep(cep),
                    total_codigos: uniqueCodes.length,
                    codigos: uniqueCodes.map(code => ({
                        codigo: code,
                        validado_por: codigosBipados[code]?.operador || 'Desconhecido',
                        horario: codigosBipados[code]?.timestamp || null
                    }))
                };
            });
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `todos_lotes_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Export lotes (old function redirect)
        function exportLotes() {
            exportAllLotes();
        }

        // Update dashboard realtime
        function updateDashboardRealtime() {
            // Only update if supervisor screen is active
            if (document.getElementById('supervisorScreen').style.display !== 'none') {
                loadDashboardData();
            }
        }

        // Modal close on click outside
        window.onclick = function(event) {
            const modal = document.getElementById('addOperatorModal');
            if (event.target === modal) {
                closeAddOperatorModal();
            }
        }
    </script>
</body>
</html>
