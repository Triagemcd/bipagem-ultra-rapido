<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Bipagem Ultra-R√°pido | GitHub Pages</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #111827;
            color: #f3f4f6;
            --light: #1f2937;
            --white: #374151;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .login-box {
            background: var(--white);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            text-align: center;
            font-size: 2em;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .header {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title {
            font-size: 1.5em;
            color: var(--primary);
            font-weight: 700;
        }

        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95em;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .main-content {
                grid-template-columns: 2fr 1fr;
            }
        }

        .panel {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .panel-title {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: var(--dark);
            font-weight: 600;
        }

        /* Scanner Input */
        .scanner-section {
            text-align: center;
        }

        .scanner-input {
            width: 100%;
            padding: 20px;
            font-size: 24px;
            text-align: center;
            border: 3px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 30px;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .scanner-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* Result Display */
        .result-display {
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 30px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .result-success {
            background: var(--success);
            color: white;
        }

        .result-error {
            background: var(--error);
            color: white;
        }

        .result-warning {
            background: var(--warning);
            color: white;
        }

        .result-neutral {
            background: var(--light);
            color: var(--dark);
            border: 2px dashed #d1d5db;
        }

        /* History */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .history-item:hover {
            background: var(--light);
        }

        .history-success {
            border-left: 4px solid var(--success);
        }

        .history-error {
            border-left: 4px solid var(--error);
        }

        .history-warning {
            border-left: 4px solid var(--warning);
        }

        .history-code {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .history-time {
            color: #6b7280;
            font-size: 0.85em;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }

        /* CEP Config */
        .cep-config {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .cep-input {
            flex: 1;
            min-width: 200px;
        }

        .cep-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .cep-tag {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cep-remove {
            cursor: pointer;
            font-weight: bold;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dark mode toggle */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .panel {
                padding: 20px;
            }

            .scanner-input {
                font-size: 18px;
                padding: 15px;
            }

            .result-display {
                font-size: 1.2em;
                padding: 30px;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1 class="login-title">üöÄ Bipagem Ultra-R√°pido</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">üë§ Matr√≠cula</label>
                    <input type="text" id="matricula" class="form-input" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">üîê Senha</label>
                    <input type="password" id="senha" class="form-input" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn">Entrar</button>
            </form>
            <div id="loginError" style="color: var(--error); text-align: center; margin-top: 20px; display: none;"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appScreen" class="app-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <h1 class="header-title">üöÄ Bipagem Ultra-R√°pido | GitHub Pages</h1>
                    <div class="header-info">
                        <div class="header-item">
                            <span>üë®‚Äçüíº</span>
                            <span id="operatorName">-</span>
                            <span id="operatorId">-</span>
                        </div>
                        <div class="header-item">
                            <span>üìç CEP:</span>
                            <span id="currentCep">N√£o configurado</span>
                        </div>
                        <div class="header-item">
                            <span>üïê</span>
                            <span id="currentTime">-</span>
                        </div>
                        <button class="btn" onclick="logout()" style="width: auto; padding: 8px 16px; font-size: 14px;">Sair</button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Left Panel - Scanner -->
                <div class="panel">
                    <h2 class="panel-title">üì¶ Valida√ß√£o de C√≥digos</h2>
                    
                    <!-- CEP Configuration -->
                    <div class="cep-config">
                        <input type="text" id="cepInput" class="form-input cep-input" placeholder="Digite o CEP da gaiola">
                        <button class="btn" onclick="addCep()" style="width: auto;">Adicionar CEP</button>
                    </div>
                    <div id="cepList" class="cep-list"></div>

                    <!-- Scanner Input -->
                    <div class="scanner-section">
                        <input 
                            type="text" 
                            id="scannerInput" 
                            class="scanner-input" 
                            placeholder="Aguardando c√≥digo..."
                            disabled
                        >
                        
                        <!-- Result Display -->
                        <div id="resultDisplay" class="result-display result-neutral">
                            <span>Pronto para iniciar</span>
                        </div>
                    </div>

                    <!-- History -->
                    <h3 class="panel-title">üìã Hist√≥rico Recente</h3>
                    <div id="historyList" class="history-list">
                        <p style="text-align: center; color: #6b7280;">Nenhuma valida√ß√£o ainda</p>
                    </div>
                </div>

                <!-- Right Panel - Statistics -->
                <div class="panel">
                    <h2 class="panel-title">üìä Estat√≠sticas da Sess√£o</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotal">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-card" style="background: rgba(34, 197, 94, 0.1);">
                            <div class="stat-value" id="statCorrect" style="color: var(--success);">0</div>
                            <div class="stat-label">‚úÖ Corretos</div>
                        </div>
                        <div class="stat-card" style="background: rgba(239, 68, 68, 0.1);">
                            <div class="stat-value" id="statError" style="color: var(--error);">0</div>
                            <div class="stat-label">‚ùå Errados</div>
                        </div>
                        <div class="stat-card" style="background: rgba(245, 158, 11, 0.1);">
                            <div class="stat-value" id="statNotFound" style="color: var(--warning);">0</div>
                            <div class="stat-label">üîç N√£o Encontrados</div>
                        </div>
                    </div>

                    <div class="stats-grid" style="margin-top: 30px;">
                        <div class="stat-card">
                            <div class="stat-value" id="statAccuracy">0%</div>
                            <div class="stat-label">Taxa de Acerto</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statAvgTime">0ms</div>
                            <div class="stat-label">Tempo M√©dio</div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="syncData()" style="width: 100%; margin-bottom: 10px;">
                            üîÑ Sincronizar Dados
                        </button>
                        <button class="btn" onclick="exportLogs()" style="width: 100%; background: #6b7280;">
                            üì• Exportar Logs
                        </button>
                    </div>

                    <!-- Loading indicator -->
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">
        <span id="darkModeIcon">üåô</span>
    </button>

    <script>
        // Global Variables
        let codesData = {};
        let operatorsData = {};
        let currentOperator = null;
        let selectedCeps = [];
        let sessionStats = {
            total: 0,
            correct: 0,
            error: 0,
            notFound: 0,
            times: []
        };
        let history = [];

        // Audio Context for beeps
        let audioContext = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Load operators data
            await loadOperatorsData();
            
            // Check for saved session
            const savedSession = localStorage.getItem('bipagem_session');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                if (session.operator && new Date() - new Date(session.timestamp) < 8 * 60 * 60 * 1000) {
                    currentOperator = session.operator;
                    await showApp();
                }
            }

            // Update time
            setInterval(updateTime, 1000);
            updateTime();

            // Dark mode
            if (window.matchMedia('(prefers-color-scheme: dark)').matches || 
                new Date().getHours() >= 20 || new Date().getHours() < 6) {
                toggleDarkMode();
            }
        });

        // Load operators data
        async function loadOperatorsData() {
            try {
                // For demo purposes, using embedded data
                operatorsData = {
                    "1234": { "nome": "Jo√£o Silva", "senha": "1234", "setor": "Expedi√ß√£o" },
                    "5678": { "nome": "Maria Santos", "senha": "5678", "setor": "Separa√ß√£o" },
                    "9999": { "nome": "Carlos Oliveira", "senha": "9999", "setor": "Confer√™ncia" }
                };
                
                // In production, load from operadores.json
                // const response = await fetch('operadores.json');
                // const data = await response.json();
                // operatorsData = data.operators;
            } catch (error) {
                console.error('Error loading operators:', error);
            }
        }

        // Load codes data
        async function loadCodesData() {
            document.getElementById('loading').style.display = 'block';
            
            try {
                // For demo purposes, using embedded data
                codesData = {
                    "BR259747338411J": "36960000",
                    "BR253223789688Z": "36950000",
                    "BR258554089877H": "35300114",
                    "BR251547397372A": "35300352",
                    "BR250479272632K": "35350000",
                    "BR252995453810J": "35334000",
                    "BR258009821176I": "35324000",
                    "BR250679813958H": "36985000",
                    "BR255038998529P": "35325000",
                    "BR255021795505T": "35323000",
                    "BR250975639954M": "35330000",
                    "BR254999675182G": "36955000",
                    "BR253288681003L": "35300238",
                    "BR258650626221K": "35300206",
                    "BR252376322316V": "35330000",
                    "BR254192166075H": "36955000",
                    "BR257915739529H": "35300333",
                    "BR259720647109B": "36950000",
                    "BR257312724687K": "36950000",
                    "BR251568951275J": "35350000",
                    "BR256418899822C": "35350000",
                    "BR250437397695I": "36955000",
                    "BR254664600882L": "36955000",
                    "BR251858464207E": "35330000",
                    "BR254916621112D": "36950000",
                    "BR253375879177S": "35300145",
                    "BR253841771153P": "35300167"
                };
                
                // In production, load from codigos.json
                // const response = await fetch('codigos.json');
                // const data = await response.json();
                // codesData = data.codes;
                
                localStorage.setItem('bipagem_codes', JSON.stringify({
                    data: codesData,
                    timestamp: new Date().toISOString()
                }));
                
            } catch (error) {
                console.error('Error loading codes:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const matricula = document.getElementById('matricula').value;
            const senha = document.getElementById('senha').value;
            const errorDiv = document.getElementById('loginError');
            
            if (operatorsData[matricula] && operatorsData[matricula].senha === senha) {
                currentOperator = {
                    matricula: matricula,
                    ...operatorsData[matricula]
                };
                
                localStorage.setItem('bipagem_session', JSON.stringify({
                    operator: currentOperator,
                    timestamp: new Date().toISOString()
                }));
                
                await showApp();
            } else {
                errorDiv.textContent = 'Matr√≠cula ou senha inv√°lida';
                errorDiv.style.display = 'block';
            }
        });

        // Show App
        async function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            
            // Update operator info
            document.getElementById('operatorName').textContent = currentOperator.nome;
            document.getElementById('operatorId').textContent = `(${currentOperator.matricula})`;
            
            // Load codes
            await loadCodesData();
            
            // Initialize audio
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Setup scanner input
            const scannerInput = document.getElementById('scannerInput');
            scannerInput.addEventListener('input', handleScan);
            
            // Load saved stats
            const savedStats = localStorage.getItem('bipagem_stats_' + currentOperator.matricula);
            if (savedStats) {
                const stats = JSON.parse(savedStats);
                if (new Date().toDateString() === new Date(stats.date).toDateString()) {
                    sessionStats = stats.stats;
                    history = stats.history || [];
                    updateStats();
                    updateHistory();
                }
            }
        }

        // Add CEP
        function addCep() {
            const input = document.getElementById('cepInput');
            const cep = input.value.replace(/\D/g, '');
            
            if (cep.length === 8 && !selectedCeps.includes(cep)) {
                selectedCeps.push(cep);
                updateCepList();
                input.value = '';
                
                // Enable scanner
                if (selectedCeps.length > 0) {
                    document.getElementById('scannerInput').disabled = false;
                    document.getElementById('scannerInput').focus();
                }
            }
        }

        // Update CEP list
        function updateCepList() {
            const container = document.getElementById('cepList');
            const currentCepDisplay = document.getElementById('currentCep');
            
            container.innerHTML = selectedCeps.map(cep => `
                <div class="cep-tag">
                    ${formatCep(cep)}
                    <span class="cep-remove" onclick="removeCep('${cep}')">√ó</span>
                </div>
            `).join('');
            
            currentCepDisplay.textContent = selectedCeps.length > 0 
                ? selectedCeps.map(formatCep).join(', ')
                : 'N√£o configurado';
        }

        // Remove CEP
        function removeCep(cep) {
            selectedCeps = selectedCeps.filter(c => c !== cep);
            updateCepList();
            
            if (selectedCeps.length === 0) {
                document.getElementById('scannerInput').disabled = true;
            }
        }

        // Format CEP
        function formatCep(cep) {
            return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
        }

        // Handle scan
        async function handleScan(e) {
            const code = e.target.value.trim();
            
            if (code.length >= 13) { // Minimum code length
                const startTime = performance.now();
                
                // Clear input immediately
                e.target.value = '';
                
                // Validate code
                const result = validateCode(code);
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                // Update display
                showResult(result, code, responseTime);
                
                // Update stats
                updateSessionStats(result.status, responseTime);
                
                // Add to history
                addToHistory(code, result, responseTime);
                
                // Play sound
                playSound(result.status);
                
                // Vibrate if available
                if ('vibrate' in navigator) {
                    navigator.vibrate(result.status === 'success' ? 50 : [100, 50, 100]);
                }
                
                // Log
                logValidation(code, result, responseTime);
            }
        }

        // Validate code
        function validateCode(code) {
            const cep = codesData[code];
            
            if (!cep) {
                return { status: 'notFound', message: 'N√ÉO ENCONTRADO' };
            }
            
            if (selectedCeps.includes(cep)) {
                return { status: 'success', message: 'CORRETO!' };
            }
            
            return { 
                status: 'error', 
                message: `ERRADO! CEP: ${formatCep(cep)}` 
            };
        }

        // Show result
        function showResult(result, code, time) {
            const display = document.getElementById('resultDisplay');
            
            // Remove all result classes
            display.classList.remove('result-success', 'result-error', 'result-warning', 'result-neutral');
            
            // Add appropriate class
            switch (result.status) {
                case 'success':
                    display.classList.add('result-success');
                    display.innerHTML = `‚úÖ ${result.message} (${time}ms)`;
                    break;
                case 'error':
                    display.classList.add('result-error');
                    display.innerHTML = `‚ùå ${result.message} (${time}ms)`;
                    break;
                case 'notFound':
                    display.classList.add('result-warning');
                    display.innerHTML = `üîç ${result.message} (${time}ms)`;
                    break;
            }
            
            // Reset after 3 seconds
            setTimeout(() => {
                display.classList.remove('result-success', 'result-error', 'result-warning');
                display.classList.add('result-neutral');
                display.innerHTML = 'Aguardando pr√≥ximo c√≥digo...';
            }, 3000);
        }

        // Update session stats
        function updateSessionStats(status, time) {
            sessionStats.total++;
            sessionStats.times.push(time);
            
            switch (status) {
                case 'success':
                    sessionStats.correct++;
                    break;
                case 'error':
                    sessionStats.error++;
                    break;
                case 'notFound':
                    sessionStats.notFound++;
                    break;
            }
            
            updateStats();
            saveStats();
        }

        // Update stats display
        function updateStats() {
            document.getElementById('statTotal').textContent = sessionStats.total;
            document.getElementById('statCorrect').textContent = sessionStats.correct;
            document.getElementById('statError').textContent = sessionStats.error;
            document.getElementById('statNotFound').textContent = sessionStats.notFound;
            
            // Calculate accuracy
            const accuracy = sessionStats.total > 0 
                ? Math.round((sessionStats.correct / sessionStats.total) * 100)
                : 0;
            document.getElementById('statAccuracy').textContent = accuracy + '%';
            
            // Calculate average time
            const avgTime = sessionStats.times.length > 0
                ? Math.round(sessionStats.times.reduce((a, b) => a + b, 0) / sessionStats.times.length)
                : 0;
            document.getElementById('statAvgTime').textContent = avgTime + 'ms';
        }

        // Add to history
        function addToHistory(code, result, time) {
            const historyItem = {
                code: code,
                result: result,
                time: time,
                timestamp: new Date()
            };
            
            history.unshift(historyItem);
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            
            updateHistory();
        }

        // Update history display
        function updateHistory() {
            const container = document.getElementById('historyList');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Nenhuma valida√ß√£o ainda</p>';
                return;
            }
            
            container.innerHTML = history.map(item => {
                let statusClass = '';
                let statusIcon = '';
                
                switch (item.result.status) {
                    case 'success':
                        statusClass = 'history-success';
                        statusIcon = '‚úÖ';
                        break;
                    case 'error':
                        statusClass = 'history-error';
                        statusIcon = '‚ùå';
                        break;
                    case 'notFound':
                        statusClass = 'history-warning';
                        statusIcon = 'üîç';
                        break;
                }
                
                return `
                    <div class="history-item ${statusClass}">
                        <div>
                            <span>${statusIcon}</span>
                            <span class="history-code">${item.code}</span>
                            <span style="color: #6b7280; font-size: 0.85em;">
                                ${item.result.status === 'error' ? item.result.message : ''}
                            </span>
                        </div>
                        <div>
                            <span style="color: #6b7280; font-size: 0.85em;">(${item.time}ms)</span>
                            <span class="history-time">${formatTime(item.timestamp)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Play sound
        function playSound(status) {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch (status) {
                case 'success':
                    oscillator.frequency.value = 800;
                    gainNode.gain.value = 0.3;
                    break;
                case 'error':
                case 'notFound':
                    oscillator.frequency.value = 300;
                    gainNode.gain.value = 0.3;
                    break;
            }
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // Save stats
        function saveStats() {
            localStorage.setItem('bipagem_stats_' + currentOperator.matricula, JSON.stringify({
                date: new Date().toISOString(),
                stats: sessionStats,
                history: history
            }));
        }

        // Log validation
        function logValidation(code, result, time) {
            const logs = JSON.parse(localStorage.getItem('bipagem_logs') || '[]');
            
            logs.push({
                timestamp: new Date().toISOString(),
                operator: currentOperator.matricula,
                code: code,
                result: result.status,
                message: result.message,
                responseTime: time,
                ceps: selectedCeps
            });
            
            // Keep only last 1000 logs
            if (logs.length > 1000) {
                logs.splice(0, logs.length - 1000);
            }
            
            localStorage.setItem('bipagem_logs', JSON.stringify(logs));
        }

        // Export logs
        function exportLogs() {
            const logs = localStorage.getItem('bipagem_logs') || '[]';
            const blob = new Blob([logs], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bipagem_logs_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Sync data
        async function syncData() {
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Check for cached data
                const cached = localStorage.getItem('bipagem_codes');
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    const age = new Date() - new Date(timestamp);
                    
                    // Use cache if less than 30 minutes old
                    if (age < 30 * 60 * 1000) {
                        codesData = data;
                        alert('Dados j√° est√£o atualizados!');
                        return;
                    }
                }
                
                // In production, fetch new data
                await loadCodesData();
                alert('Dados sincronizados com sucesso!');
                
            } catch (error) {
                alert('Erro ao sincronizar dados: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Logout
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('bipagem_session');
                currentOperator = null;
                selectedCeps = [];
                sessionStats = {
                    total: 0,
                    correct: 0,
                    error: 0,
                    notFound: 0,
                    times: []
                };
                history = [];
                
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('loginForm').reset();
            }
        }

        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('darkModeIcon');
            icon.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
        }

        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        // Format time
        function formatTime(date) {
            return new Date(date).toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Keep focus on scanner input
        setInterval(() => {
            const scannerInput = document.getElementById('scannerInput');
            if (document.getElementById('appScreen').style.display !== 'none' && 
                !scannerInput.disabled && 
                document.activeElement !== scannerInput) {
                scannerInput.focus();
            }
        }, 100);

        // Handle Enter key on CEP input
        document.getElementById('cepInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCep();
            }
        });

        // Prevent form resubmission
        window.addEventListener('beforeunload', (e) => {
            if (sessionStats.total > 0) {
                saveStats();
            }
        });
    </script>
</body>
</html>